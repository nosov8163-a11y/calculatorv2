<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Набор калькуляторов - ПАРИТЕТ ДЕВЕЛОПМЕНТ</title>
    <style>
        /* Основные цвета бренда */
        :root {
            --white: #FFFFFF;
            --red: #F50024;
            --black: #000000;
            --light-gray: #f5f5f5;
            --dark-gray: #333333;
            --border-color: #e0e0e0;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--white);
            color: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--red);
            width: 100%;
        }
        
        h1 {
            color: var(--black);
            margin-top: 20px;
        }
        
        .calculator-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .calc-button {
            background-color: var(--white);
            color: var(--black);
            border: 2px solid var(--red);
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .calc-button:hover {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calc-button.active {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calculator-container {
            display: flex;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            justify-content: center;
        }
        
        .calculator-form {
            flex: 0 0 45%;
            background: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .calculator-results {
            flex: 0 0 45%;
            background: var(--light-gray);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--red);
        }
        
        .calculator-section {
            display: none;
            width: 100%;
            justify-content: center;
        }
        
        .calculator-section.active {
            display: flex;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--black);
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .highlight {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--red);
        }
        
        .price-comparison {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background: var(--light-gray);
            border-radius: 5px;
        }
        
        .discount {
            color: var(--red);
            font-weight: bold;
        }
        
        .no-discount {
            color: var(--dark-gray);
            font-weight: bold;
        }
        
        .warning {
            color: var(--red);
            font-weight: bold;
        }
        
        .apartment-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .sold-notice {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .mortgage-block {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .mortgage-block h3 {
            margin-top: 0;
            color: var(--black);
            border-bottom: 2px solid var(--red);
            padding-bottom: 10px;
        }
        
        .payment-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .apartment-details {
            margin-top: 20px;
            padding: 15px;
            background: var(--light-gray);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .apartment-details h3 {
            margin-top: 0;
            color: var(--black);
        }
        
        .apartment-details div {
            margin-bottom: 5px;
        }
        
        h2 {
            margin-top: 0;
            color: var(--black);
        }
        
        .plan-button {
            background-color: var(--red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
        }
        
        .plan-button:hover {
            background-color: #d4001f;
        }
        
        .plan-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .additional-costs {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .manager-discount {
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .min-payment-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 5px;
        }
        
        .complex-display {
            padding: 8px;
            background: #f8d7da;
            border-radius: 4px;
            border: 1px solid var(--red);
            font-weight: bold;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .calculator-container {
                flex-direction: column;
            }
            
            .calculator-buttons {
                flex-direction: column;
            }
            
            .calculator-form, .calculator-results {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Набор калькуляторов</h1>
        <div class="calculator-buttons">
            <button class="calc-button active" data-calc="chpv">Расчет ЧПВ</button>
            <button class="calc-button" data-calc="kv">Расчет КВ</button>
        </div>
    </div>

    <!-- Калькулятор ЧПВ 300 000 -->
    <div id="chpv-calculator" class="calculator-section active">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор КВ</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="chpv-complexSelect">Жилой комплекс:</label>
                    <select id="chpv-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv-sectionSelect">Название дома:</label>
                    <select id="chpv-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv-apartmentSelect">Квартира:</label>
                    <select id="chpv-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="chpv-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="chpv-apartmentDetails"></div>
                </div>

                <div id="chpv-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="chpv-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <div class="manager-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="chpv-managerDiscount">
                        <label for="chpv-managerDiscount">Скидка менеджера</label>
                    </div>
                    <div style="font-size: 0.9em; color: var(--dark-gray);">
                        При включенной скидке менеджера цена уменьшается на 100,000 ₽
                    </div>
                </div>
                
                <!-- Дополнительные расходы -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="chpv-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="chpv-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="chpv-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="chpv-dduObjects" value="0" min="0" step="10000">
                    </div>
                </div>
                
                <!-- Первоначальный взнос клиента -->
                <div class="form-group">
                    <label for="chpv-clientDownPayment">Первоначальный взнос клиента (₽):</label>
                    <input type="number" id="chpv-clientDownPayment" value="0" min="0" step="10000">
                    <div id="chpv-minPaymentInfo" class="min-payment-info"></div>
                </div>
                
                <div id="chpv-paymentWarning" class="payment-warning" style="display: none;">
                    Первоначальный взнос клиента меньше минимального требуемого!
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                <div class="result-item">
                    <span>Стоимость договора для ДДУ:</span>
                    <span id="chpv-resultContractPrice" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Общий ПВ:</span>
                    <span id="chpv-resultTotalPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Паритет ПВ:</span>
                    <span id="chpv-resultCompanyPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Клиента ПВ:</span>
                    <span id="chpv-resultClientPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Тело кредита:</span>
                    <span id="chpv-resultLoanBody" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Скидка на квартиру без учета ремонта:</span>
                    <span id="chpv-resultDiscountWithoutRepair" class="no-discount">Нет скидки</span>
                </div>
                
                <div id="chpv-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="chpv-apartmentComplex"></div>
                    <div id="chpv-apartmentSection"></div>
                    <div id="chpv-apartmentNumber"></div>
                    <div id="chpv-apartmentRooms"></div>
                    <div id="chpv-apartmentArea"></div>
                    <div id="chpv-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Калькулятор КВ -->
    <div id="kv-calculator" class="calculator-section">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор ЧПВ</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="kv-complexSelect">Жилой комплекс:</label>
                    <select id="kv-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-sectionSelect">Название дома:</label>
                    <select id="kv-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-apartmentSelect">Квартира:</label>
                    <select id="kv-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="kv-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="kv-apartmentDetails"></div>
                </div>

                <div id="kv-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="kv-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <div class="manager-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="kv-managerDiscount">
                        <label for="kv-managerDiscount">Скидка менеджера</label>
                    </div>
                    <div style="font-size: 0.9em; color: var(--dark-gray);">
                        При включенной скидке менеджера цена уменьшается на 100,000 ₽
                    </div>
                </div>
                
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="kv-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="kv-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-kvSubsidy">Субсидия КВ в %:</label>
                        <input type="number" id="kv-kvSubsidy" value="4.5" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="kv-dduObjects" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-clientPVPercent">ПВ клиента (%):</label>
                        <input type="number" id="kv-clientPVPercent" value="20.1" min="0" step="0.1">
                    </div>
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                
                <!-- Блок для семейной ипотеки -->
                <div class="mortgage-block">
                    <h3>Семейная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-familyClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>КВ рублей:</span>
                        <span id="kv-familyKV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-familyContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-familyLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-familyDiscount" class="no-discount">Нет скидки</span>
                    </div>
                    <div id="kv-familyWarning" class="payment-warning" style="display: none;">
                        Увеличить ПВ клиента
                    </div>
                </div>
                
                <!-- Блок для стандартной ипотеки -->
                <div class="mortgage-block">
                    <h3>Стандартная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-standardClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>КВ рублей:</span>
                        <span id="kv-standardKV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-standardContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-standardLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-standardDiscount" class="no-discount">Нет скидки</span>
                    </div>
                </div>
                
                <div id="kv-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="kv-apartmentComplex"></div>
                    <div id="kv-apartmentSection"></div>
                    <div id="kv-apartmentNumber"></div>
                    <div id="kv-apartmentRooms"></div>
                    <div id="kv-apartmentArea"></div>
                    <div id="kv-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Общие функции
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ₽';
        }

        function getRoomTypeText(roomType) {
            const roomTypes = {
                0: 'Студия',
                1: '1-комнатная',
                2: '2-комнатная',
                3: '3-комнатная'
            };
            return roomTypes[roomType] || 'Неизвестно';
        }

        // Переключение между калькуляторами
        const calculatorButtons = document.querySelectorAll('.calc-button');
        const calculatorSections = document.querySelectorAll('.calculator-section');

        calculatorButtons.forEach(button => {
            button.addEventListener('click', () => {
                const calculatorId = button.getAttribute('data-calc');
                
                // Убираем активный класс у всех кнопок
                calculatorButtons.forEach(btn => btn.classList.remove('active'));
                // Добавляем активный класс текущей кнопке
                button.classList.add('active');
                
                // Скрываем все калькуляторы
                calculatorSections.forEach(section => section.classList.remove('active'));
                // Показываем выбранный калькулятор
                document.getElementById(`${calculatorId}-calculator`).classList.add('active');
            });
        });

        // ==================== КАЛЬКУЛЯТОР ЧПВ 300 000 ====================
        // Элементы DOM для ЧПВ
        const chpvComplexSelect = document.getElementById('chpv-complexSelect');
        const chpvSectionSelect = document.getElementById('chpv-sectionSelect');
        const chpvApartmentSelect = document.getElementById('chpv-apartmentSelect');
        const chpvSelectedApartmentInfo = document.getElementById('chpv-selectedApartmentInfo');
        const chpvApartmentDetails = document.getElementById('chpv-apartmentDetails');
        const chpvSoldNotice = document.getElementById('chpv-soldNotice');
        const chpvBasePriceDisplay = document.getElementById('chpv-basePriceDisplay');
        const chpvManagerDiscountCheckbox = document.getElementById('chpv-managerDiscount');
        const chpvRepairCostInput = document.getElementById('chpv-repairCost');
        const chpvDduObjectsInput = document.getElementById('chpv-dduObjects');
        const chpvClientDownPaymentInput = document.getElementById('chpv-clientDownPayment');
        const chpvMinPaymentInfo = document.getElementById('chpv-minPaymentInfo');
        const chpvPaymentWarning = document.getElementById('chpv-paymentWarning');
        const chpvApartmentFullDetails = document.getElementById('chpv-apartmentFullDetails');
        
        // Результаты для ЧПВ
        const chpvResultContractPrice = document.getElementById('chpv-resultContractPrice');
        const chpvResultTotalPV = document.getElementById('chpv-resultTotalPV');
        const chpvResultCompanyPV = document.getElementById('chpv-resultCompanyPV');
        const chpvResultClientPV = document.getElementById('chpv-resultClientPV');
        const chpvResultLoanBody = document.getElementById('chpv-resultLoanBody');
        const chpvResultDiscountWithoutRepair = document.getElementById('chpv-resultDiscountWithoutRepair');
        
        // Информация о квартире для ЧПВ
        const chpvApartmentComplex = document.getElementById('chpv-apartmentComplex');
        const chpvApartmentSection = document.getElementById('chpv-apartmentSection');
        const chpvApartmentNumber = document.getElementById('chpv-apartmentNumber');
        const chpvApartmentRooms = document.getElementById('chpv-apartmentRooms');
        const chpvApartmentArea = document.getElementById('chpv-apartmentArea');
        const chpvApartmentPlan = document.getElementById('chpv-apartmentPlan');

        // Данные из Google Таблицы
        let apartmentsData = [];
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVMdD1qLq8N3hBj1OV-xVXz5T9wwOcDTPSa09j5Ty7kxm7YY1SErU5fXkoqWxO2zZ2/exec';

        // Текущие цены выбранной квартиры для ЧПВ
        let chpvCurrentBasePrice = 0;
        let chpvCurrentDiscountPrice = 0;
        let chpvCurrentStatus = '';
        let chpvCurrentComplex = '';
        let chpvCurrentSection = '';
        let chpvCurrentApartmentNumber = '';
        let chpvCurrentRoomType = '';
        let chpvCurrentArea = '';
        let chpvCurrentPlanUrl = '';

        // Коэффициенты для расчета минимального ПВ для ЧПВ
        const chpvCoefficients = {
            'АСТРО': [
                { max: 5000000, value: 0.10 },
                { max: 8000000, value: 0.12 },
                { max: 12000000, value: 0.15 }
            ],
            'ЧИСТЫЕ ПРУДЫ': [
                { max: 5000000, value: 0.095 },
                { max: 8000000, value: 0.105 },
                { max: 14000000, value: 0.135 }
            ],
            'Счастье': [
                { max: 2000000, value: 0.065 },
                { max: 3500000, value: 0.09 },
                { max: 6500000, value: 0.11 }
            ],
            'Тёплые кварталы': [
                { max: 5000000, value: 0.105 },
                { max: 8000000, value: 0.125 },
                { max: 14000000, value: 0.145 }
            ],
            'Бодровский': [
                { max: 5000000, value: 0.10 },
                { max: 8000000, value: 0.12 },
                { max: 14000000, value: 0.14 }
            ],
            'Комсомольский': [
                { max: 5000000, value: 0.10 },
                { max: 8000000, value: 0.12 },
                { max: 14000000, value: 0.14 }
            ]
        };

        // ЖК с фиксированным минимальным ПВ 300 000 ₽ для ЧПВ
        const chpvFixedMinPaymentComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
        const CHPV_FIXED_MIN_PAYMENT = 300000;

        // Функция для получения коэффициента для ЖК для ЧПВ
        function chpvGetCoefficient(complex, basePrice) {
            const complexCoeffs = chpvCoefficients[complex];
            if (!complexCoeffs) return 0.10; // По умолчанию 10%
            
            for (let i = 0; i < complexCoeffs.length; i++) {
                if (basePrice <= complexCoeffs[i].max) {
                    return complexCoeffs[i].value;
                }
            }
            
            // Если цена выше всех порогов, берем последний коэффициент
            return complexCoeffs[complexCoeffs.length - 1].value;
        }

        // Функция проверки, является ли ЖК с фиксированным минимальным ПВ для ЧПВ
        function chpvIsFixedMinPaymentComplex(complex) {
            return chpvFixedMinPaymentComplexes.includes(complex);
        }

        // Функция расчета минимального ПВ клиента для ЧПВ
        function chpvCalculateMinClientPayment() {
            // Если ЖК в списке с фиксированным минимальным ПВ, возвращаем 300 000 ₽
            if (chpvIsFixedMinPaymentComplex(chpvCurrentComplex)) {
                return CHPV_FIXED_MIN_PAYMENT;
            }
            
            // Для остальных ЖК считаем по коэффициенту
            const repairCost = parseInt(chpvRepairCostInput.value) || 0;
            const dduObjects = parseInt(chpvDduObjectsInput.value) || 0;
            const totalBase = chpvCurrentBasePrice + repairCost + dduObjects;
            const coefficient = chpvGetCoefficient(chpvCurrentComplex, chpvCurrentBasePrice);
            
            return Math.round(totalBase * coefficient);
        }

        // Функция получения скорректированной цены со скидкой (с учетом чекбокса) для ЧПВ
        function chpvGetAdjustedDiscountPrice() {
            return chpvManagerDiscountCheckbox.checked ? 
                chpvCurrentDiscountPrice : 
                chpvCurrentDiscountPrice + 100000;
        }

        // Функция расчета стоимости договора для ДДУ для ЧПВ
        function chpvCalculateContractPrice() {
            const adjustedDiscountPrice = chpvGetAdjustedDiscountPrice();
            const repairCost = parseInt(chpvRepairCostInput.value) || 0;
            const dduObjects = parseInt(chpvDduObjectsInput.value) || 0;
            const clientPV = parseInt(chpvClientDownPaymentInput.value) || 0;
            
            // Итеративный расчет стоимости договора
            let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
            let companyPV = 0;
            
            // Выполняем несколько итераций для точного расчета
            for (let i = 0; i < 10; i++) {
                companyPV = contractPrice * 0.201 - clientPV;
                const newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + companyPV + companyPV * 0.05;
                
                // Если разница меньше 1 рубля, выходим
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                contractPrice = newContractPrice;
            }
            
            return Math.round(contractPrice);
        }
        
        // Функция расчета скидки на квартиру без учета ремонта для ЧПВ
        function chpvCalculateDiscountWithoutRepair(contractPrice) {
            const repairCost = parseInt(chpvRepairCostInput.value) || 0;
            const priceWithoutRepair = contractPrice - repairCost;
            
            if (priceWithoutRepair < chpvCurrentBasePrice) {
                return Math.ceil(chpvCurrentBasePrice - priceWithoutRepair);
            }
            return 0;
        }
        
        // Функция сброса расчетов для ЧПВ
        function chpvResetCalculation() {
            chpvCurrentBasePrice = 0;
            chpvCurrentDiscountPrice = 0;
            chpvCurrentStatus = '';
            chpvUpdatePriceDisplay();
            
            chpvResultContractPrice.textContent = formatMoney(0);
            chpvResultTotalPV.textContent = formatMoney(0);
            chpvResultCompanyPV.textContent = formatMoney(0);
            chpvResultClientPV.textContent = formatMoney(0);
            chpvResultLoanBody.textContent = formatMoney(0);
            chpvResultDiscountWithoutRepair.textContent = "Нет скидки";
            chpvResultDiscountWithoutRepair.className = "no-discount";
            
            chpvMinPaymentInfo.textContent = '';
            chpvPaymentWarning.style.display = 'none';
        }
        
        // Функция обновления отображения цен для ЧПВ
        function chpvUpdatePriceDisplay() {
            chpvBasePriceDisplay.textContent = formatMoney(chpvCurrentBasePrice);
        }

        // Функция обновления полной информации о квартире для ЧПВ
        function chpvUpdateApartmentFullDetails() {
            chpvApartmentComplex.textContent = `Жилой комплекс: ${chpvCurrentComplex}`;
            chpvApartmentSection.textContent = `Дом: ${chpvCurrentSection}`;
            chpvApartmentNumber.textContent = `Квартира: ${chpvCurrentApartmentNumber}`;
            chpvApartmentRooms.textContent = `Комнатность: ${getRoomTypeText(parseInt(chpvCurrentRoomType))}`;
            chpvApartmentArea.textContent = `Площадь: ${chpvCurrentArea} м²`;
            
            // Добавляем кнопку плана квартиры, если есть ссылка
            if (chpvCurrentPlanUrl && chpvCurrentPlanUrl.trim() !== '') {
                chpvApartmentPlan.innerHTML = `<a href="${chpvCurrentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
            } else {
                chpvApartmentPlan.innerHTML = '';
            }
            
            chpvApartmentFullDetails.style.display = 'block';
        }
        
        // Функция расчета для ЧПВ
        function chpvCalculate() {
            if (chpvCurrentStatus === "Продано") {
                return; // Не проводим расчеты для проданных квартир
            }
            
            const clientPV = parseInt(chpvClientDownPaymentInput.value) || 0;
            
            // Рассчитываем минимальный ПВ клиента
            const minClientPayment = chpvCalculateMinClientPayment();
            
            // Обновляем информацию о минимальном платеже
            if (chpvIsFixedMinPaymentComplex(chpvCurrentComplex)) {
                chpvMinPaymentInfo.textContent = `Минимальный первоначальный взнос: ${formatMoney(CHPV_FIXED_MIN_PAYMENT)}`;
            } else {
                const coefficient = chpvGetCoefficient(chpvCurrentComplex, chpvCurrentBasePrice);
                chpvMinPaymentInfo.textContent = `Минимальный первоначальный взнос: ${formatMoney(minClientPayment)}`;
            }
            
            // Проверяем, достаточно ли ПВ клиента
            if (clientPV < minClientPayment) {
                chpvPaymentWarning.style.display = 'block';
                const amountToAdd = minClientPayment - clientPV;
                chpvPaymentWarning.textContent = `Первоначальный взнос клиента меньше минимального требуемого! Необходимо добавить еще ${formatMoney(amountToAdd)}`;
                
                // Сбрасываем результаты, если ПВ недостаточно
                chpvResultContractPrice.textContent = formatMoney(0);
                chpvResultTotalPV.textContent = formatMoney(0);
                chpvResultCompanyPV.textContent = formatMoney(0);
                chpvResultClientPV.textContent = formatMoney(clientPV);
                chpvResultLoanBody.textContent = formatMoney(0);
                chpvResultDiscountWithoutRepair.textContent = "Нет скидки";
                chpvResultDiscountWithoutRepair.className = "no-discount";
                return;
            } else {
                chpvPaymentWarning.style.display = 'none';
            }
            
            // Рассчитываем стоимость договора для ДДУ
            const contractPrice = chpvCalculateContractPrice();
            
            // Рассчитываем остальные показатели
            const totalPV = Math.round(contractPrice * 0.201);
            const companyPV = totalPV - clientPV;
            const loanBody = contractPrice - totalPV;
            
            // Рассчитываем скидку на квартиру без учета ремонта
            const discountWithoutRepair = chpvCalculateDiscountWithoutRepair(contractPrice);
            
            chpvResultContractPrice.textContent = formatMoney(contractPrice);
            chpvResultTotalPV.textContent = formatMoney(totalPV);
            chpvResultCompanyPV.textContent = formatMoney(companyPV);
            chpvResultClientPV.textContent = formatMoney(clientPV);
            chpvResultLoanBody.textContent = formatMoney(loanBody);
            
            // Обновляем отображение скидки
            if (discountWithoutRepair > 0) {
                chpvResultDiscountWithoutRepair.textContent = formatMoney(discountWithoutRepair);
                chpvResultDiscountWithoutRepair.className = "discount";
            } else {
                chpvResultDiscountWithoutRepair.textContent = "Нет скидки";
                chpvResultDiscountWithoutRepair.className = "no-discount";
            }
        }

        // Инициализация калькулятора ЧПВ
        function initCHPVCalculator() {
            // Заполнение списка ЖК для ЧПВ
            function chpvPopulateComplexes() {
                const complexes = [...new Set(apartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
                chpvComplexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
                complexes.forEach(complex => {
                    const option = document.createElement('option');
                    option.value = complex;
                    option.textContent = complex;
                    chpvComplexSelect.appendChild(option);
                });
            }

            // При изменении ЖК для ЧПВ
            chpvComplexSelect.addEventListener('change', function() {
                const complex = this.value;
                chpvSectionSelect.disabled = !complex;
                chpvApartmentSelect.disabled = true;
                chpvApartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                chpvSelectedApartmentInfo.style.display = 'none';
                chpvSoldNotice.style.display = 'none';
                chpvApartmentFullDetails.style.display = 'none';
                chpvResetCalculation();

                if (complex) {
                    const sections = [...new Set(apartmentsData
                        .filter(item => item["Название ЖК"] === complex)
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    chpvSectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        chpvSectionSelect.appendChild(option);
                    });
                }
            });

            // При изменении дома для ЧПВ
            chpvSectionSelect.addEventListener('change', function() {
                const complex = chpvComplexSelect.value;
                const section = this.value;
                chpvApartmentSelect.disabled = !section;
                chpvSelectedApartmentInfo.style.display = 'none';
                chpvSoldNotice.style.display = 'none';
                chpvApartmentFullDetails.style.display = 'none';
                chpvResetCalculation();

                if (complex && section) {
                    const apartments = apartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            planUrl: item["3D тур квартиры"]
                        }));

                    chpvApartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.planUrl = apartment.planUrl || '';
                        chpvApartmentSelect.appendChild(option);
                    });
                }
            });

            // При изменении квартиры для ЧПВ
            chpvApartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                chpvSelectedApartmentInfo.style.display = 'none';
                chpvSoldNotice.style.display = 'none';
                chpvApartmentFullDetails.style.display = 'none';
                chpvResetCalculation();

                if (selectedOption.value) {
                    chpvCurrentBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    chpvCurrentDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    chpvCurrentStatus = selectedOption.dataset.status || '';
                    chpvCurrentComplex = selectedOption.dataset.complex;
                    chpvCurrentSection = selectedOption.dataset.section;
                    chpvCurrentApartmentNumber = selectedOption.value;
                    chpvCurrentRoomType = selectedOption.dataset.roomType;
                    chpvCurrentArea = selectedOption.dataset.area;
                    chpvCurrentPlanUrl = selectedOption.dataset.planUrl;

                    // Проверяем статус квартиры
                    if (chpvCurrentStatus === "Продано") {
                        chpvSoldNotice.style.display = 'block';
                        return;
                    }

                    // Обновляем информацию о выбранной квартире
                    chpvApartmentDetails.innerHTML = `
                        <div>ЖК: ${chpvCurrentComplex}</div>
                        <div>Дом: ${chpvCurrentSection}</div>
                        <div>Квартира: ${chpvCurrentApartmentNumber}</div>
                    `;
                    chpvSelectedApartmentInfo.style.display = 'block';

                    // Обновляем полную информацию о квартире в результатах
                    chpvUpdateApartmentFullDetails();

                    // Обновляем отображение цен
                    chpvUpdatePriceDisplay();
                    
                    chpvCalculate();
                }
            });

            // Слушатели событий для ЧПВ
            chpvManagerDiscountCheckbox.addEventListener('change', function() {
                chpvUpdatePriceDisplay();
                chpvCalculate();
            });
            
            chpvRepairCostInput.addEventListener('input', chpvCalculate);
            chpvDduObjectsInput.addEventListener('input', chpvCalculate);
            chpvClientDownPaymentInput.addEventListener('input', chpvCalculate);

            // Заполняем списки для ЧПВ
            chpvPopulateComplexes();
        }

        // ==================== КАЛЬКУЛЯТОР КВ ====================
        // Элементы DOM для КВ
        const kvComplexSelect = document.getElementById('kv-complexSelect');
        const kvSectionSelect = document.getElementById('kv-sectionSelect');
        const kvApartmentSelect = document.getElementById('kv-apartmentSelect');
        const kvSelectedApartmentInfo = document.getElementById('kv-selectedApartmentInfo');
        const kvApartmentDetails = document.getElementById('kv-apartmentDetails');
        const kvSoldNotice = document.getElementById('kv-soldNotice');
        const kvBasePriceDisplay = document.getElementById('kv-basePriceDisplay');
        const kvManagerDiscountCheckbox = document.getElementById('kv-managerDiscount');
        const kvRepairCostInput = document.getElementById('kv-repairCost');
        const kvDduObjectsInput = document.getElementById('kv-dduObjects');
        const kvKvSubsidyInput = document.getElementById('kv-kvSubsidy');
        const kvClientPVPercentInput = document.getElementById('kv-clientPVPercent');
        const kvApartmentFullDetails = document.getElementById('kv-apartmentFullDetails');
        
        // Результаты для семейной ипотеки КВ
        const kvFamilyClientPV = document.getElementById('kv-familyClientPV');
        const kvFamilyKV = document.getElementById('kv-familyKV');
        const kvFamilyContractPrice = document.getElementById('kv-familyContractPrice');
        const kvFamilyLoanBody = document.getElementById('kv-familyLoanBody');
        const kvFamilyDiscount = document.getElementById('kv-familyDiscount');
        const kvFamilyWarning = document.getElementById('kv-familyWarning');
        
        // Результаты для стандартной ипотеки КВ
        const kvStandardClientPV = document.getElementById('kv-standardClientPV');
        const kvStandardKV = document.getElementById('kv-standardKV');
        const kvStandardContractPrice = document.getElementById('kv-standardContractPrice');
        const kvStandardLoanBody = document.getElementById('kv-standardLoanBody');
        const kvStandardDiscount = document.getElementById('kv-standardDiscount');
        
        // Информация о квартире для КВ
        const kvApartmentComplex = document.getElementById('kv-apartmentComplex');
        const kvApartmentSection = document.getElementById('kv-apartmentSection');
        const kvApartmentNumber = document.getElementById('kv-apartmentNumber');
        const kvApartmentRooms = document.getElementById('kv-apartmentRooms');
        const kvApartmentArea = document.getElementById('kv-apartmentArea');
        const kvApartmentPlan = document.getElementById('kv-apartmentPlan');

        // Текущие цены выбранной квартиры для КВ
        let kvCurrentBasePrice = 0;
        let kvCurrentDiscountPrice = 0;
        let kvCurrentStatus = '';
        let kvCurrentComplex = '';
        let kvCurrentSection = '';
        let kvCurrentApartmentNumber = '';
        let kvCurrentRoomType = '';
        let kvCurrentArea = '';
        let kvCurrentPlanUrl = '';

        // Функция получения скорректированной цены со скидкой (с учетом чекбокса) для КВ
        function kvGetAdjustedDiscountPrice() {
            return kvManagerDiscountCheckbox.checked ? 
                kvCurrentDiscountPrice : 
                kvCurrentDiscountPrice + 100000;
        }

        // Функция округления до 4 знаков (до 10000) для КВ
        function kvRoundUpTo4Digits(amount) {
            return Math.ceil(amount / 10000) * 10000;
        }
        
        // Функция расчета скидки на квартиру без учета ремонта для КВ
        function kvCalculateDiscountWithoutRepair(contractPrice, repairCost) {
            const priceWithoutRepair = contractPrice - repairCost;
            
            if (priceWithoutRepair < kvCurrentBasePrice) {
                return Math.ceil(kvCurrentBasePrice - priceWithoutRepair);
            }
            return 0;
        }
        
        // Функция сброса расчетов для КВ
        function kvResetCalculation() {
            kvCurrentBasePrice = 0;
            kvCurrentDiscountPrice = 0;
            kvCurrentStatus = '';
            kvUpdatePriceDisplay();
            
            kvFamilyClientPV.textContent = formatMoney(0);
            kvFamilyKV.textContent = formatMoney(0);
            kvFamilyContractPrice.textContent = formatMoney(0);
            kvFamilyLoanBody.textContent = formatMoney(0);
            kvFamilyDiscount.textContent = "Нет скидки";
            kvFamilyDiscount.className = "no-discount";
            kvFamilyWarning.style.display = 'none';
            
            kvStandardClientPV.textContent = formatMoney(0);
            kvStandardKV.textContent = formatMoney(0);
            kvStandardContractPrice.textContent = formatMoney(0);
            kvStandardLoanBody.textContent = formatMoney(0);
            kvStandardDiscount.textContent = "Нет скидки";
            kvStandardDiscount.className = "no-discount";
        }
        
        // Функция обновления отображения цен для КВ
        function kvUpdatePriceDisplay() {
            kvBasePriceDisplay.textContent = formatMoney(kvCurrentBasePrice);
        }

        // Функция обновления полной информации о квартире для КВ
        function kvUpdateApartmentFullDetails() {
            kvApartmentComplex.textContent = `Жилой комплекс: ${kvCurrentComplex}`;
            kvApartmentSection.textContent = `Дом: ${kvCurrentSection}`;
            kvApartmentNumber.textContent = `Квартира: ${kvCurrentApartmentNumber}`;
            kvApartmentRooms.textContent = `Комнатность: ${getRoomTypeText(parseInt(kvCurrentRoomType))}`;
            kvApartmentArea.textContent = `Площадь: ${kvCurrentArea} м²`;
            
            // Добавляем кнопку плана квартиры, если есть ссылка
            if (kvCurrentPlanUrl && kvCurrentPlanUrl.trim() !== '') {
                kvApartmentPlan.innerHTML = `<a href="${kvCurrentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
            } else {
                kvApartmentPlan.innerHTML = '';
            }
            
            kvApartmentFullDetails.style.display = 'block';
        }
        
        // Функция расчета для семейной ипотеки КВ
        function kvCalculateFamilyMortgage() {
            const adjustedDiscountPrice = kvGetAdjustedDiscountPrice();
            const repairCost = parseInt(kvRepairCostInput.value) || 0;
            const dduObjects = parseInt(kvDduObjectsInput.value) || 0;
            const kvSubsidyPercent = parseFloat(kvKvSubsidyInput.value) || 0;
            const clientPVPercent = parseFloat(kvClientPVPercentInput.value) || 0;
            
            // Рассчитываем стоимость договора для ДДУ
            let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
            let iterations = 0;
            const maxIterations = 20;
            
            while (iterations < maxIterations) {
                // Рассчитываем ПВ клиента в рублях
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                
                // Проверяем условие для семейной ипотеки
                if (contractPrice - clientPVRub >= 6000000) {
                    kvFamilyWarning.style.display = 'block';
                    kvFamilyClientPV.textContent = "Увеличить ПВ клиента";
                    kvFamilyKV.textContent = formatMoney(0);
                    kvFamilyContractPrice.textContent = formatMoney(0);
                    kvFamilyLoanBody.textContent = formatMoney(0);
                    kvFamilyDiscount.textContent = "Нет скидки";
                    kvFamilyDiscount.className = "no-discount";
                    return;
                }
                
                // Рассчитываем КВ в рублях
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                
                // Рассчитываем новую стоимость договора
                let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                newContractPrice = kvRoundUpTo4Digits(newContractPrice);
                
                // Если разница меньше 1 рубля, выходим
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                
                contractPrice = newContractPrice;
                iterations++;
            }
            
            // Рассчитываем финальные значения
            let clientPVRub = contractPrice * (clientPVPercent / 100);
            let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
            let loanBody = contractPrice - clientPVRub;
            
            // Проверяем условие еще раз
            if (contractPrice - clientPVRub >= 6000000) {
                kvFamilyWarning.style.display = 'block';
                kvFamilyClientPV.textContent = "Увеличить ПВ клиента";
                kvFamilyKV.textContent = formatMoney(0);
                kvFamilyContractPrice.textContent = formatMoney(0);
                kvFamilyLoanBody.textContent = formatMoney(0);
                kvFamilyDiscount.textContent = "Нет скидки";
                kvFamilyDiscount.className = "no-discount";
                return;
            }
            
            // Рассчитываем скидку
            const discountWithoutRepair = kvCalculateDiscountWithoutRepair(contractPrice, repairCost);
            
            // Обновляем результаты
            kvFamilyClientPV.textContent = formatMoney(clientPVRub);
            kvFamilyKV.textContent = formatMoney(kvRub);
            kvFamilyContractPrice.textContent = formatMoney(contractPrice);
            kvFamilyLoanBody.textContent = formatMoney(loanBody);
            
            if (discountWithoutRepair > 0) {
                kvFamilyDiscount.textContent = formatMoney(discountWithoutRepair);
                kvFamilyDiscount.className = "discount";
            } else {
                kvFamilyDiscount.textContent = "Нет скидки";
                kvFamilyDiscount.className = "no-discount";
            }
            
            kvFamilyWarning.style.display = 'none';
        }
        
        // Функция расчета для стандартной ипотеки КВ
        function kvCalculateStandardMortgage() {
            const adjustedDiscountPrice = kvGetAdjustedDiscountPrice();
            const repairCost = parseInt(kvRepairCostInput.value) || 0;
            const dduObjects = parseInt(kvDduObjectsInput.value) || 0;
            const kvSubsidyPercent = parseFloat(kvKvSubsidyInput.value) || 0;
            const clientPVPercent = parseFloat(kvClientPVPercentInput.value) || 0;
            
            // Рассчитываем стоимость договора для ДДУ
            let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
            let iterations = 0;
            const maxIterations = 20;
            
            while (iterations < maxIterations) {
                // Рассчитываем ПВ клиента в рублях
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                
                // Рассчитываем КВ в рублях
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                
                // Рассчитываем новую стоимость договора
                let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                newContractPrice = kvRoundUpTo4Digits(newContractPrice);
                
                // Если разница меньше 1 рубля, выходим
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                
                contractPrice = newContractPrice;
                iterations++;
            }
            
            // Рассчитываем финальные значения
            let clientPVRub = contractPrice * (clientPVPercent / 100);
            let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
            let loanBody = contractPrice - clientPVRub;
            
            // Рассчитываем скидку
            const discountWithoutRepair = kvCalculateDiscountWithoutRepair(contractPrice, repairCost);
            
            // Обновляем результаты
            kvStandardClientPV.textContent = formatMoney(clientPVRub);
            kvStandardKV.textContent = formatMoney(kvRub);
            kvStandardContractPrice.textContent = formatMoney(contractPrice);
            kvStandardLoanBody.textContent = formatMoney(loanBody);
            
            if (discountWithoutRepair > 0) {
                kvStandardDiscount.textContent = formatMoney(discountWithoutRepair);
                kvStandardDiscount.className = "discount";
            } else {
                kvStandardDiscount.textContent = "Нет скидки";
                kvStandardDiscount.className = "no-discount";
            }
        }
        
        // Функция расчета для КВ
        function kvCalculate() {
            if (kvCurrentStatus === "Продано") {
                return; // Не проводим расчеты для проданных квартир
            }
            
            kvCalculateFamilyMortgage();
            kvCalculateStandardMortgage();
        }

        // Инициализация калькулятора КВ
        function initKVCalculator() {
            // Заполнение списка ЖК для КВ
            function kvPopulateComplexes() {
                const complexes = [...new Set(apartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
                kvComplexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
                complexes.forEach(complex => {
                    const option = document.createElement('option');
                    option.value = complex;
                    option.textContent = complex;
                    kvComplexSelect.appendChild(option);
                });
            }

            // При изменении ЖК для КВ
            kvComplexSelect.addEventListener('change', function() {
                const complex = this.value;
                kvSectionSelect.disabled = !complex;
                kvApartmentSelect.disabled = true;
                kvApartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                kvSelectedApartmentInfo.style.display = 'none';
                kvSoldNotice.style.display = 'none';
                kvApartmentFullDetails.style.display = 'none';
                kvResetCalculation();

                if (complex) {
                    const sections = [...new Set(apartmentsData
                        .filter(item => item["Название ЖК"] === complex)
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    kvSectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        kvSectionSelect.appendChild(option);
                    });
                }
            });

            // При изменении дома для КВ
            kvSectionSelect.addEventListener('change', function() {
                const complex = kvComplexSelect.value;
                const section = this.value;
                kvApartmentSelect.disabled = !section;
                kvSelectedApartmentInfo.style.display = 'none';
                kvSoldNotice.style.display = 'none';
                kvApartmentFullDetails.style.display = 'none';
                kvResetCalculation();

                if (complex && section) {
                    const apartments = apartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            planUrl: item["3D тур квартиры"]
                        }));

                    kvApartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.planUrl = apartment.planUrl || '';
                        kvApartmentSelect.appendChild(option);
                    });
                }
            });

            // При изменении квартиры для КВ
            kvApartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                kvSelectedApartmentInfo.style.display = 'none';
                kvSoldNotice.style.display = 'none';
                kvApartmentFullDetails.style.display = 'none';
                kvResetCalculation();

                if (selectedOption.value) {
                    kvCurrentBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    kvCurrentDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    kvCurrentStatus = selectedOption.dataset.status || '';
                    kvCurrentComplex = selectedOption.dataset.complex;
                    kvCurrentSection = selectedOption.dataset.section;
                    kvCurrentApartmentNumber = selectedOption.value;
                    kvCurrentRoomType = selectedOption.dataset.roomType;
                    kvCurrentArea = selectedOption.dataset.area;
                    kvCurrentPlanUrl = selectedOption.dataset.planUrl;

                    // Проверяем статус квартиры
                    if (kvCurrentStatus === "Продано") {
                        kvSoldNotice.style.display = 'block';
                        return;
                    }

                    // Обновляем информацию о выбранной квартире
                    kvApartmentDetails.innerHTML = `
                        <div>ЖК: ${kvCurrentComplex}</div>
                        <div>Дом: ${kvCurrentSection}</div>
                        <div>Квартира: ${kvCurrentApartmentNumber}</div>
                    `;
                    kvSelectedApartmentInfo.style.display = 'block';

                    // Обновляем полную информацию о квартире в результатах
                    kvUpdateApartmentFullDetails();

                    // Обновляем отображение цен
                    kvUpdatePriceDisplay();
                    
                    kvCalculate();
                }
            });

            // Слушатели событий для КВ
            kvManagerDiscountCheckbox.addEventListener('change', kvCalculate);
            kvRepairCostInput.addEventListener('input', kvCalculate);
            kvDduObjectsInput.addEventListener('input', kvCalculate);
            kvKvSubsidyInput.addEventListener('input', kvCalculate);
            kvClientPVPercentInput.addEventListener('input', kvCalculate);

            // Заполняем списки для КВ
            kvPopulateComplexes();
        }

        // ==================== ОБЩАЯ ЗАГРУЗКА ДАННЫХ ====================
        // Загрузка данных из Google Таблицы
        async function loadApartmentsData() {
            try {
                chpvComplexSelect.innerHTML = '<option value="">Загрузка...</option>';
                kvComplexSelect.innerHTML = '<option value="">Загрузка...</option>';
                
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                // Фильтруем только квартиры и исключаем статус "Субаренда (продано)"
                // Теперь включаем проект "АСТРО"
                apartmentsData = data.filter(item => {
                    const isApartment = item["Тип помещения"] && item["Тип помещения"].toLowerCase() === "квартира";
                    const isNotSubRent = item["Статус"] !== "Субаренда (продано)";
                    
                    return isApartment && isNotSubRent;
                });
                
                // Инициализируем оба калькулятора
                initCHPVCalculator();
                initKVCalculator();
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                chpvComplexSelect.innerHTML = '<option value="">Ошибка загрузки данных</option>';
                kvComplexSelect.innerHTML = '<option value="">Ошибка загрузки данных</option>';
            }
        }

        // Инициализация при загрузке страницы
        loadApartmentsData();
    </script>
</body>
</html>
