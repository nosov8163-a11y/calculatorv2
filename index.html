<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Набор калькуляторов - ПАРИТЕТ ДЕВЕЛОПМЕНТ</title>
    <style>
        /* Основные цвета бренда */
        :root {
            --white: #FFFFFF;
            --red: #F50024;
            --black: #000000;
            --light-gray: #f5f5f5;
            --dark-gray: #333333;
            --border-color: #e0e0e0;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--white);
            color: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--red);
            width: 100%;
        }
        
        h1 {
            color: var(--black);
            margin-top: 20px;
        }
        
        .calculator-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .calc-button {
            background-color: var(--white);
            color: var(--black);
            border: 2px solid var(--red);
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .calc-button:hover {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calc-button.active {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calculator-container {
            display: flex;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            justify-content: center;
        }
        
        .calculator-form {
            flex: 0 0 45%;
            background: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .calculator-results {
            flex: 0 0 45%;
            background: var(--light-gray);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--red);
        }
        
        .calculator-section {
            display: none;
            width: 100%;
            justify-content: center;
        }
        
        .calculator-section.active {
            display: flex;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--black);
        }
        
        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .highlight {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--red);
        }
        
        .price-comparison {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background: var(--light-gray);
            border-radius: 5px;
        }
        
        .discount {
            color: var(--red);
            font-weight: bold;
        }
        
        .no-discount {
            color: var(--dark-gray);
            font-weight: bold;
        }
        
        .warning {
            color: var(--red);
            font-weight: bold;
        }
        
        .apartment-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .sold-notice {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .mortgage-block {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .mortgage-block h3 {
            margin-top: 0;
            color: var(--black);
            border-bottom: 2px solid var(--red);
            padding-bottom: 10px;
        }
        
        .payment-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .apartment-details {
            margin-top: 20px;
            padding: 15px;
            background: var(--light-gray);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .apartment-details h3 {
            margin-top: 0;
            color: var(--black);
        }
        
        .apartment-details div {
            margin-bottom: 5px;
        }
        
        h2 {
            margin-top: 0;
            color: var(--black);
        }
        
        .plan-button {
            background-color: var(--red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
        }
        
        .plan-button:hover {
            background-color: #d4001f;
        }
        
        .plan-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .additional-costs {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .manager-discount {
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .input-with-slider {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .manual-input {
            width: 150px;
        }
        
        .term-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 5px;
        }
        
        .min-payment-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 5px;
        }
        
        .complex-display {
            padding: 8px;
            background: #f8d7da;
            border-radius: 4px;
            border: 1px solid var(--red);
            font-weight: bold;
            color: #721c24;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #d1d1d1;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
        }
        
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        
        .bank-discount {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .commission-input-container {
            margin-top: 10px;
            padding: 10px;
            background: #e2f4f8;
            border-radius: 5px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .calculator-container {
                flex-direction: column;
            }
            
            .calculator-buttons {
                flex-direction: column;
            }
            
            .calculator-form, .calculator-results {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Набор калькуляторов</h1>
        <div class="calculator-buttons">
            <button class="calc-button active" data-calc="chpv300">Калькулятор ЧПВ 300 000 + 3% КВ </button>
            <button class="calc-button" data-calc="kv">Расчет КВ</button>
        </div>
    </div>

    <!-- Калькулятор ЧПВ 300 000 + 3% КВ  -->
    <div id="chpv300-calculator" class="calculator-section active">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор ЧПВ 300 000 + 3% КВ </h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="chpv300-complexSelect">Жилой комплекс:</label>
                    <select id="chpv300-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv300-sectionSelect">Название дома:</label>
                    <select id="chpv300-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv300-apartmentSelect">Квартира:</label>
                    <select id="chpv300-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="chpv300-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="chpv300-apartmentDetails"></div>
                </div>

                <div id="chpv300-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="chpv300-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <div class="manager-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="chpv300-managerDiscount">
                        <label for="chpv300-managerDiscount">Скидка менеджера</label>
                    </div>
                    <div style="font-size: 0.9em; color: var(--dark-gray);">
                        При включенной скидке менеджера цена уменьшается на 100,000 ₽
                    </div>
                </div>
                
                <div class="bank-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="chpv300-bankDiscount">
                        <label for="chpv300-bankDiscount">Комиссия банка</label>
                    </div>
                    <div style="font-size: 0.9em; color: #17a2b8;">
                        При включении добавляется комиссия банка от тела кредита (по умолчанию 9,5%)
                    </div>
                    <div id="chpv300-commissionInputContainer" class="commission-input-container">
                        <div class="form-group">
                            <label for="chpv300-bankCommissionPercent">Процент комиссии банка (%):</label>
                            <input type="number" id="chpv300-bankCommissionPercent" value="9.5" min="0" max="100" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Дополнительные расходы -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="chpv300-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="chpv300-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="chpv300-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="chpv300-dduObjects" value="0" min="0" step="10000">
                    </div>
                </div>
                
                <!-- Первоначальный взнос клиента -->
                <div class="form-group">
                    <label for="chpv300-clientDownPayment">Первоначальный взнос клиента (₽):</label>
                    <input type="number" id="chpv300-clientDownPayment" value="0" min="0" step="10000">
                    <div id="chpv300-minPaymentInfo" class="min-payment-info"></div>
                </div>
                
                <div id="chpv300-paymentWarning" class="payment-warning" style="display: none;">
                    Первоначальный взнос клиента меньше минимального требуемого!
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                <div class="result-item">
                    <span>Стоимость договора для ДДУ:</span>
                    <span id="chpv300-resultContractPrice" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Общий ПВ:</span>
                    <span id="chpv300-resultTotalPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Паритет ПВ:</span>
                    <span id="chpv300-resultCompanyPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Клиента ПВ:</span>
                    <span id="chpv300-resultClientPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Тело кредита:</span>
                    <span id="chpv300-resultLoanBody" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Процент ПВ:</span>
                    <span id="chpv300-resultPVPercent" class="highlight">0%</span>
                </div>
                <div id="chpv300-bankCommissionItem" class="result-item" style="display: none;">
                    <span>Комиссия банка:</span>
                    <span id="chpv300-resultBankCommission" class="info">0 ₽</span>
                </div>
                <div id="chpv300-bankCommissionPercentItem" class="result-item" style="display: none;">
                    <span>Процент комиссии:</span>
                    <span id="chpv300-resultBankCommissionPercent" class="info">0%</span>
                </div>
                <div class="result-item">
                    <span>Скидка на квартиру без учета ремонта:</span>
                    <span id="chpv300-resultDiscountWithoutRepair" class="no-discount">Нет скидки</span>
                </div>
                
                <div id="chpv300-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="chpv300-apartmentComplex"></div>
                    <div id="chpv300-apartmentSection"></div>
                    <div id="chpv300-apartmentNumber"></div>
                    <div id="chpv300-apartmentRooms"></div>
                    <div id="chpv300-apartmentArea"></div>
                    <div id="chpv300-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Калькулятор КВ -->
    <div id="kv-calculator" class="calculator-section">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор КВ</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="kv-complexSelect">Жилой комплекс:</label>
                    <select id="kv-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-sectionSelect">Название дома:</label>
                    <select id="kv-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-apartmentSelect">Квартира:</label>
                    <select id="kv-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="kv-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="kv-apartmentDetails"></div>
                </div>

                <div id="kv-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="kv-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <!-- Чекбокс скидки менеджера -->
                <div class="manager-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="kv-managerDiscount">
                        <label for="kv-managerDiscount">Скидка менеджера</label>
                    </div>
                    <div style="font-size: 0.9em; color: var(--dark-gray);">
                        При включенной скидке менеджера цена уменьшается на 100,000 ₽
                    </div>
                </div>
                
                <!-- Новые поля для ввода -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="kv-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="kv-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-kvSubsidy">Субсидия КВ в %:</label>
                        <input type="number" id="kv-kvSubsidy" value="4.5" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="kv-dduObjects" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-clientPVPercent">ПВ клиента (%):</label>
                        <input type="number" id="kv-clientPVPercent" value="20.1" min="0" step="0.1">
                    </div>
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                
                <!-- Блок для семейной ипотеки -->
                <div class="mortgage-block">
                    <h3>Семейная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-familyClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>КВ рублей:</span>
                        <span id="kv-familyKV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-familyContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-familyLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-familyDiscount" class="no-discount">Нет скидки</span>
                    </div>
                    <div id="kv-familyWarning" class="payment-warning" style="display: none;">
                        Увеличить ПВ клиента
                    </div>
                </div>
                
                <!-- Блок для стандартной ипотеки -->
                <div class="mortgage-block">
                    <h3>Стандартная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-standardClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>КВ рублей:</span>
                        <span id="kv-standardKV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-standardContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-standardLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-standardDiscount" class="no-discount">Нет скидки</span>
                    </div>
                </div>
                
                <div id="kv-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="kv-apartmentComplex"></div>
                    <div id="kv-apartmentSection"></div>
                    <div id="kv-apartmentNumber"></div>
                    <div id="kv-apartmentRooms"></div>
                    <div id="kv-apartmentArea"></div>
                    <div id="kv-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Общие функции
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ₽';
        }

        function getRoomTypeText(roomType) {
            const roomTypes = {
                0: 'Студия',
                1: '1-комнатная',
                2: '2-комнатная',
                3: '3-комнатная'
            };
            return roomTypes[roomType] || 'Неизвестно';
        }

        // Переключение между калькуляторами
        const calculatorButtons = document.querySelectorAll('.calc-button');
        const calculatorSections = document.querySelectorAll('.calculator-section');

        calculatorButtons.forEach(button => {
            button.addEventListener('click', () => {
                const calculatorId = button.getAttribute('data-calc');
                
                // Убираем активный класс у всех кнопок
                calculatorButtons.forEach(btn => btn.classList.remove('active'));
                // Добавляем активный класс текущей кнопке
                button.classList.add('active');
                
                // Скрываем все калькуляторы
                calculatorSections.forEach(section => section.classList.remove('active'));
                // Показываем выбранный калькулятор
                document.getElementById(`${calculatorId}-calculator`).classList.add('active');
                
                // Инициализируем выбранный калькулятор
                if (calculatorId === 'chpv300') {
                    if (!chpv300DataLoaded) {
                        loadChpv300ApartmentsData();
                    }
                } else if (calculatorId === 'kv') {
                    if (!kvDataLoaded) {
                        loadKvApartmentsData();
                    }
                }
            });
        });

        // ==================== КАЛЬКУЛЯТОР ЧПВ 300 000 + 3%   ====================
        let chpv300DataLoaded = false;
        let chpv300ApartmentsData = [];
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVMdD1qLq8N3hBj1OV-xVXz5T9wwOcDTPSa09j5Ty7kxm7YY1SErU5fXkoqWxO2zZ2/exec';

        // Текущие цены выбранной квартиры для ЧПВ300
        let chpv300CurrentBasePrice = 0;
        let chpv300CurrentOriginalBasePrice = 0;
        let chpv300CurrentDiscountPrice = 0;
        let chpv300CurrentOriginalDiscountPrice = 0;
        let chpv300CurrentStatus = '';
        let chpv300CurrentComplex = '';
        let chpv300CurrentSection = '';
        let chpv300CurrentApartmentNumber = '';
        let chpv300CurrentRoomType = '';
        let chpv300CurrentArea = '';
        let chpv300CurrentPlanUrl = '';

        // ЖК с увеличенной ценой на 3% (только для цены со скидкой)
        const chpv300IncreasedPriceComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
        const chpv300PRICE_INCREASE_RATE = 0.03;

        // Коэффициенты для расчета минимального ПВ
        const chpv300Coefficients = {
            'АСТРО': [
                { max: 5000000, value: 0.10 },
                { max: 8000000, value: 0.12 },
                { max: 12000000, value: 0.15 }
            ],
            'ЧИСТЫЕ ПРУДЫ': [
                { max: 5000000, value: 0.095 },
                { max: 8000000, value: 0.105 },
                { max: 14000000, value: 0.135 }
            ],
            'Счастье': [
                { max: 2000000, value: 0.065 },
                { max: 3500000, value: 0.09 },
                { max: 6500000, value: 0.11 }
            ],
            'Тёплые кварталы': [
                { max: 5000000, value: 0.105 },
                { max: 8000000, value: 0.125 },
                { max: 14000000, value: 0.145 }
            ],
            'Бодровский': [
                { max: 5000000, value: 0.10 },
                { max: 8000000, value: 0.12 },
                { max: 14000000, value: 0.14 }
            ],
            'Комсомольский': [
                { max: 5000000, value: 0.10 },
                { max: 8000000, value: 0.12 },
                { max: 14000000, value: 0.14 }
            ]
        };

        // ЖК с фиксированным минимальным ПВ 300 000 ₽
        const chpv300FixedMinPaymentComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
        const chpv300FIXED_MIN_PAYMENT = 300000;

        // Функция для получения коэффициента для ЖК
        function chpv300GetCoefficient(complex, basePrice) {
            const complexCoeffs = chpv300Coefficients[complex];
            if (!complexCoeffs) return 0.10;
            
            for (let i = 0; i < complexCoeffs.length; i++) {
                if (basePrice <= complexCoeffs[i].max) {
                    return complexCoeffs[i].value;
                }
            }
            
            return complexCoeffs[complexCoeffs.length - 1].value;
        }

        // Функция проверки, является ли ЖК с фиксированным минимальным ПВ
        function chpv300IsFixedMinPaymentComplex(complex) {
            return chpv300FixedMinPaymentComplexes.includes(complex);
        }

        // Функция проверки, нужно ли увеличивать цену со скидкой для ЖК
        function chpv300IsPriceIncreasedComplex(complex) {
            return chpv300IncreasedPriceComplexes.includes(complex);
        }

        // Функция расчета минимального ПВ клиента
        function chpv300CalculateMinClientPayment() {
            if (chpv300IsFixedMinPaymentComplex(chpv300CurrentComplex)) {
                return chpv300FIXED_MIN_PAYMENT;
            }
            
            const repairCost = parseInt(document.getElementById('chpv300-repairCost').value) || 0;
            const dduObjects = parseInt(document.getElementById('chpv300-dduObjects').value) || 0;
            const totalBase = chpv300CurrentBasePrice + repairCost + dduObjects;
            const coefficient = chpv300GetCoefficient(chpv300CurrentComplex, chpv300CurrentBasePrice);
            
            return Math.round(totalBase * coefficient);
        }

        // Загрузка данных для ЧПВ300
        async function loadChpv300ApartmentsData() {
            try {
                const complexSelect = document.getElementById('chpv300-complexSelect');
                complexSelect.innerHTML = '<option value="">Загрузка...</option>';
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                chpv300ApartmentsData = data.filter(item => {
                    const isApartment = item["Тип помещения"] && item["Тип помещения"].toLowerCase() === "квартира";
                    const isNotSubRent = item["Статус"] !== "Субаренда (продано)";
                    
                    return isApartment && isNotSubRent;
                });
                
                chpv300PopulateComplexes();
                chpv300DataLoaded = true;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('chpv300-complexSelect').innerHTML = '<option value="">Ошибка загрузки данных</option>';
            }
        }

        // Заполнение списка ЖК для ЧПВ300
        function chpv300PopulateComplexes() {
            const complexSelect = document.getElementById('chpv300-complexSelect');
            const complexes = [...new Set(chpv300ApartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
            complexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
            complexes.forEach(complex => {
                const option = document.createElement('option');
                option.value = complex;
                option.textContent = complex;
                complexSelect.appendChild(option);
            });
        }

        // Инициализация событий для ЧПВ300
        function initChpv300Events() {
            const complexSelect = document.getElementById('chpv300-complexSelect');
            const sectionSelect = document.getElementById('chpv300-sectionSelect');
            const apartmentSelect = document.getElementById('chpv300-apartmentSelect');
            
            complexSelect.addEventListener('change', function() {
                const complex = this.value;
                sectionSelect.disabled = !complex;
                apartmentSelect.disabled = true;
                apartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                document.getElementById('chpv300-selectedApartmentInfo').style.display = 'none';
                document.getElementById('chpv300-soldNotice').style.display = 'none';
                document.getElementById('chpv300-apartmentFullDetails').style.display = 'none';
                chpv300ResetCalculation();

                if (complex) {
                    const sections = [...new Set(chpv300ApartmentsData
                        .filter(item => item["Название ЖК"] === complex)
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    sectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        sectionSelect.appendChild(option);
                    });
                }
            });

            sectionSelect.addEventListener('change', function() {
                const complex = complexSelect.value;
                const section = this.value;
                apartmentSelect.disabled = !section;
                document.getElementById('chpv300-selectedApartmentInfo').style.display = 'none';
                document.getElementById('chpv300-soldNotice').style.display = 'none';
                document.getElementById('chpv300-apartmentFullDetails').style.display = 'none';
                chpv300ResetCalculation();

                if (complex && section) {
                    const apartments = chpv300ApartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            planUrl: item["3D тур квартиры"]
                        }));

                    apartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.planUrl = apartment.planUrl || '';
                        apartmentSelect.appendChild(option);
                    });
                }
            });

            apartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('chpv300-selectedApartmentInfo').style.display = 'none';
                document.getElementById('chpv300-soldNotice').style.display = 'none';
                document.getElementById('chpv300-apartmentFullDetails').style.display = 'none';
                chpv300ResetCalculation();

                if (selectedOption.value) {
                    chpv300CurrentOriginalBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    chpv300CurrentOriginalDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    
                    chpv300CurrentStatus = selectedOption.dataset.status || '';
                    chpv300CurrentComplex = selectedOption.dataset.complex;
                    chpv300CurrentSection = selectedOption.dataset.section;
                    chpv300CurrentApartmentNumber = selectedOption.value;
                    chpv300CurrentRoomType = selectedOption.dataset.roomType;
                    chpv300CurrentArea = selectedOption.dataset.area;
                    chpv300CurrentPlanUrl = selectedOption.dataset.planUrl;

                    chpv300CurrentBasePrice = chpv300CurrentOriginalBasePrice;
                    
                    if (chpv300IsPriceIncreasedComplex(chpv300CurrentComplex)) {
                        chpv300CurrentDiscountPrice = Math.round(chpv300CurrentOriginalDiscountPrice * (1 + chpv300PRICE_INCREASE_RATE));
                    } else {
                        chpv300CurrentDiscountPrice = chpv300CurrentOriginalDiscountPrice;
                    }

                    if (chpv300CurrentStatus === "Продано") {
                        document.getElementById('chpv300-soldNotice').style.display = 'block';
                        return;
                    }

                    document.getElementById('chpv300-apartmentDetails').innerHTML = `
                        <div>ЖК: ${chpv300CurrentComplex}</div>
                        <div>Дом: ${chpv300CurrentSection}</div>
                        <div>Квартира: ${chpv300CurrentApartmentNumber}</div>
                    `;
                    document.getElementById('chpv300-selectedApartmentInfo').style.display = 'block';

                    chpv300UpdateApartmentFullDetails();
                    chpv300UpdatePriceDisplay();
                    
                    chpv300Calculate();
                }
            });

            // Слушатели событий для ЧПВ300
            document.getElementById('chpv300-managerDiscount').addEventListener('change', function() {
                chpv300UpdatePriceDisplay();
                chpv300Calculate();
            });
            
            document.getElementById('chpv300-bankDiscount').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('chpv300-commissionInputContainer').style.display = 'block';
                } else {
                    document.getElementById('chpv300-commissionInputContainer').style.display = 'none';
                }
                chpv300Calculate();
            });
            
            document.getElementById('chpv300-bankCommissionPercent').addEventListener('input', chpv300Calculate);
            document.getElementById('chpv300-repairCost').addEventListener('input', chpv300Calculate);
            document.getElementById('chpv300-dduObjects').addEventListener('input', chpv300Calculate);
            document.getElementById('chpv300-clientDownPayment').addEventListener('input', chpv300Calculate);
        }

        // Функция обновления полной информации о квартире для ЧПВ300
        function chpv300UpdateApartmentFullDetails() {
            document.getElementById('chpv300-apartmentComplex').textContent = `Жилой комплекс: ${chpv300CurrentComplex}`;
            document.getElementById('chpv300-apartmentSection').textContent = `Дом: ${chpv300CurrentSection}`;
            document.getElementById('chpv300-apartmentNumber').textContent = `Квартира: ${chpv300CurrentApartmentNumber}`;
            document.getElementById('chpv300-apartmentRooms').textContent = `Комнатность: ${getRoomTypeText(parseInt(chpv300CurrentRoomType))}`;
            document.getElementById('chpv300-apartmentArea').textContent = `Площадь: ${chpv300CurrentArea} м²`;
            
            if (chpv300CurrentPlanUrl && chpv300CurrentPlanUrl.trim() !== '') {
                document.getElementById('chpv300-apartmentPlan').innerHTML = `<a href="${chpv300CurrentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
            } else {
                document.getElementById('chpv300-apartmentPlan').innerHTML = '';
            }
            
            document.getElementById('chpv300-apartmentFullDetails').style.display = 'block';
        }

        // Функция обновления отображения цен для ЧПВ300
        function chpv300UpdatePriceDisplay() {
            document.getElementById('chpv300-basePriceDisplay').textContent = formatMoney(chpv300CurrentBasePrice);
        }

        // Функция получения скорректированной цены со скидкой (с учетом скидки менеджера)
        function chpv300GetAdjustedDiscountPrice() {
            return document.getElementById('chpv300-managerDiscount').checked ? 
                chpv300CurrentDiscountPrice : 
                chpv300CurrentDiscountPrice + 100000;
        }

        // Функция получения текущей комиссии банка
        function chpv300GetBankCommissionRate() {
            if (!document.getElementById('chpv300-bankDiscount').checked) return 0;
            const commissionPercent = parseFloat(document.getElementById('chpv300-bankCommissionPercent').value) || 9.5;
            return commissionPercent / 100;
        }
        
        // Функция расчета стоимости договора для ДДУ БЕЗ комиссии банка
        function chpv300CalculateContractPriceWithoutBankCommission() {
            const adjustedDiscountPrice = chpv300GetAdjustedDiscountPrice();
            const repairCost = parseInt(document.getElementById('chpv300-repairCost').value) || 0;
            const dduObjects = parseInt(document.getElementById('chpv300-dduObjects').value) || 0;
            const clientPV = parseInt(document.getElementById('chpv300-clientDownPayment').value) || 0;
            
            let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
            
            for (let i = 0; i < 20; i++) {
                let totalPV = Math.ceil(contractPrice * 0.201);
                let companyPV = totalPV - clientPV;
                let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + companyPV + companyPV * 0.05;
                
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                contractPrice = newContractPrice;
            }
            
            return Math.round(contractPrice);
        }
        
        // Функция расчета стоимости договора для ДДУ С комиссией банка
        function chpv300CalculateContractPriceWithBankCommission() {
            const adjustedDiscountPrice = chpv300GetAdjustedDiscountPrice();
            const repairCost = parseInt(document.getElementById('chpv300-repairCost').value) || 0;
            const dduObjects = parseInt(document.getElementById('chpv300-dduObjects').value) || 0;
            const clientPV = parseInt(document.getElementById('chpv300-clientDownPayment').value) || 0;
            const bankCommissionRate = chpv300GetBankCommissionRate();
            
            let contractPrice = chpv300CalculateContractPriceWithoutBankCommission();
            let bankCommission = 0;
            
            for (let i = 0; i < 20; i++) {
                let totalPV = Math.ceil(contractPrice * 0.201);
                let companyPV = totalPV - clientPV;
                let loanBody = contractPrice - totalPV;
                bankCommission = Math.round(loanBody * bankCommissionRate);
                let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + companyPV + companyPV * 0.05 + bankCommission;
                
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                contractPrice = newContractPrice;
            }
            
            return {
                contractPrice: Math.round(contractPrice),
                bankCommission: bankCommission,
                bankCommissionRate: bankCommissionRate
            };
        }
        
        // Функция расчета скидки на квартиру без учета ремонта
        function chpv300CalculateDiscountWithoutRepair(contractPrice) {
            const repairCost = parseInt(document.getElementById('chpv300-repairCost').value) || 0;
            const priceWithoutRepair = contractPrice - repairCost;
            
            if (priceWithoutRepair < chpv300CurrentBasePrice) {
                return Math.ceil(chpv300CurrentBasePrice - priceWithoutRepair);
            }
            return 0;
        }
        
        // Функция сброса расчетов для ЧПВ300
        function chpv300ResetCalculation() {
            chpv300CurrentBasePrice = 0;
            chpv300CurrentOriginalBasePrice = 0;
            chpv300CurrentDiscountPrice = 0;
            chpv300CurrentOriginalDiscountPrice = 0;
            chpv300CurrentStatus = '';
            chpv300UpdatePriceDisplay();
            
            document.getElementById('chpv300-resultContractPrice').textContent = formatMoney(0);
            document.getElementById('chpv300-resultTotalPV').textContent = formatMoney(0);
            document.getElementById('chpv300-resultCompanyPV').textContent = formatMoney(0);
            document.getElementById('chpv300-resultClientPV').textContent = formatMoney(0);
            document.getElementById('chpv300-resultLoanBody').textContent = formatMoney(0);
            document.getElementById('chpv300-resultPVPercent').textContent = "0%";
            document.getElementById('chpv300-resultBankCommission').textContent = formatMoney(0);
            document.getElementById('chpv300-resultBankCommissionPercent').textContent = "0%";
            document.getElementById('chpv300-bankCommissionItem').style.display = 'none';
            document.getElementById('chpv300-bankCommissionPercentItem').style.display = 'none';
            document.getElementById('chpv300-resultDiscountWithoutRepair').textContent = "Нет скидки";
            document.getElementById('chpv300-resultDiscountWithoutRepair').className = "no-discount";
            
            document.getElementById('chpv300-minPaymentInfo').textContent = '';
            document.getElementById('chpv300-paymentWarning').style.display = 'none';
        }
        
        // Функция расчета для ЧПВ300
        function chpv300Calculate() {
            if (chpv300CurrentStatus === "Продано") {
                return;
            }
            
            const clientPV = parseInt(document.getElementById('chpv300-clientDownPayment').value) || 0;
            const forBank = document.getElementById('chpv300-bankDiscount').checked;
            
            const minClientPayment = chpv300CalculateMinClientPayment();
            
            if (chpv300IsFixedMinPaymentComplex(chpv300CurrentComplex)) {
                document.getElementById('chpv300-minPaymentInfo').textContent = `Минимальный первоначальный взнос: ${formatMoney(chpv300FIXED_MIN_PAYMENT)}`;
            } else {
                const coefficient = chpv300GetCoefficient(chpv300CurrentComplex, chpv300CurrentBasePrice);
                document.getElementById('chpv300-minPaymentInfo').textContent = `Минимальный первоначальный взнос: ${formatMoney(minClientPayment)}`;
            }
            
            if (clientPV < minClientPayment) {
                document.getElementById('chpv300-paymentWarning').style.display = 'block';
                const amountToAdd = minClientPayment - clientPV;
                document.getElementById('chpv300-paymentWarning').textContent = `Первоначальный взнос клиента меньше минимального требуемого! Необходимо добавить еще ${formatMoney(amountToAdd)}`;
                
                document.getElementById('chpv300-resultContractPrice').textContent = formatMoney(0);
                document.getElementById('chpv300-resultTotalPV').textContent = formatMoney(0);
                document.getElementById('chpv300-resultCompanyPV').textContent = formatMoney(0);
                document.getElementById('chpv300-resultClientPV').textContent = formatMoney(clientPV);
                document.getElementById('chpv300-resultLoanBody').textContent = formatMoney(0);
                document.getElementById('chpv300-resultPVPercent').textContent = "0%";
                document.getElementById('chpv300-resultBankCommission').textContent = formatMoney(0);
                document.getElementById('chpv300-resultBankCommissionPercent').textContent = "0%";
                document.getElementById('chpv300-bankCommissionItem').style.display = 'none';
                document.getElementById('chpv300-bankCommissionPercentItem').style.display = 'none';
                document.getElementById('chpv300-resultDiscountWithoutRepair').textContent = "Нет скидки";
                document.getElementById('chpv300-resultDiscountWithoutRepair').className = "no-discount";
                return;
            } else {
                document.getElementById('chpv300-paymentWarning').style.display = 'none';
            }
            
            let contractPrice, bankCommission, bankCommissionRate;
            
            if (forBank) {
                const calculationResult = chpv300CalculateContractPriceWithBankCommission();
                contractPrice = calculationResult.contractPrice;
                bankCommission = calculationResult.bankCommission;
                bankCommissionRate = calculationResult.bankCommissionRate;
            } else {
                contractPrice = chpv300CalculateContractPriceWithoutBankCommission();
                bankCommission = 0;
                bankCommissionRate = 0;
            }
            
            const totalPV = Math.ceil(contractPrice * 0.201);
            const companyPV = totalPV - clientPV;
            const loanBody = contractPrice - totalPV;
            const pvPercent = (totalPV / contractPrice * 100).toFixed(6);
            const discountWithoutRepair = chpv300CalculateDiscountWithoutRepair(contractPrice);
            
            document.getElementById('chpv300-resultContractPrice').textContent = formatMoney(contractPrice);
            document.getElementById('chpv300-resultTotalPV').textContent = formatMoney(totalPV);
            document.getElementById('chpv300-resultCompanyPV').textContent = formatMoney(companyPV);
            document.getElementById('chpv300-resultClientPV').textContent = formatMoney(clientPV);
            document.getElementById('chpv300-resultLoanBody').textContent = formatMoney(loanBody);
            document.getElementById('chpv300-resultPVPercent').textContent = `${pvPercent}%`;
            
            if (forBank) {
                document.getElementById('chpv300-resultBankCommission').textContent = formatMoney(bankCommission);
                document.getElementById('chpv300-resultBankCommissionPercent').textContent = `${(bankCommissionRate * 100).toFixed(1)}%`;
                document.getElementById('chpv300-bankCommissionItem').style.display = 'flex';
                document.getElementById('chpv300-bankCommissionPercentItem').style.display = 'flex';
            } else {
                document.getElementById('chpv300-bankCommissionItem').style.display = 'none';
                document.getElementById('chpv300-bankCommissionPercentItem').style.display = 'none';
            }
            
            if (discountWithoutRepair > 0) {
                document.getElementById('chpv300-resultDiscountWithoutRepair').textContent = formatMoney(discountWithoutRepair);
                document.getElementById('chpv300-resultDiscountWithoutRepair').className = "discount";
            } else {
                document.getElementById('chpv300-resultDiscountWithoutRepair').textContent = "Нет скидки";
                document.getElementById('chpv300-resultDiscountWithoutRepair').className = "no-discount";
            }
        }

        // ==================== КАЛЬКУЛЯТОР КВ ====================
        let kvDataLoaded = false;
        let kvApartmentsData = [];

        // Текущие цены выбранной квартиры для КВ
        let kvCurrentBasePrice = 0;
        let kvCurrentDiscountPrice = 0;
        let kvCurrentStatus = '';
        let kvCurrentComplex = '';
        let kvCurrentSection = '';
        let kvCurrentApartmentNumber = '';
        let kvCurrentRoomType = '';
        let kvCurrentArea = '';
        let kvCurrentPlanUrl = '';

        // Загрузка данных для КВ
        async function loadKvApartmentsData() {
            try {
                const complexSelect = document.getElementById('kv-complexSelect');
                complexSelect.innerHTML = '<option value="">Загрузка...</option>';
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                kvApartmentsData = data.filter(item => {
                    const isApartment = item["Тип помещения"] && item["Тип помещения"].toLowerCase() === "квартира";
                    const isNotSubRent = item["Статус"] !== "Субаренда (продано)";
                    
                    return isApartment && isNotSubRent;
                });
                
                kvPopulateComplexes();
                kvDataLoaded = true;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('kv-complexSelect').innerHTML = '<option value="">Ошибка загрузки данных</option>';
            }
        }

        // Заполнение списка ЖК для КВ
        function kvPopulateComplexes() {
            const complexSelect = document.getElementById('kv-complexSelect');
            const complexes = [...new Set(kvApartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
            complexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
            complexes.forEach(complex => {
                const option = document.createElement('option');
                option.value = complex;
                option.textContent = complex;
                complexSelect.appendChild(option);
            });
        }

        // Инициализация событий для КВ
        function initKvEvents() {
            const complexSelect = document.getElementById('kv-complexSelect');
            const sectionSelect = document.getElementById('kv-sectionSelect');
            const apartmentSelect = document.getElementById('kv-apartmentSelect');
            
            complexSelect.addEventListener('change', function() {
                const complex = this.value;
                sectionSelect.disabled = !complex;
                apartmentSelect.disabled = true;
                apartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                document.getElementById('kv-selectedApartmentInfo').style.display = 'none';
                document.getElementById('kv-soldNotice').style.display = 'none';
                document.getElementById('kv-apartmentFullDetails').style.display = 'none';
                kvResetCalculation();

                if (complex) {
                    const sections = [...new Set(kvApartmentsData
                        .filter(item => item["Название ЖК"] === complex)
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    sectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        sectionSelect.appendChild(option);
                    });
                }
            });

            sectionSelect.addEventListener('change', function() {
                const complex = complexSelect.value;
                const section = this.value;
                apartmentSelect.disabled = !section;
                document.getElementById('kv-selectedApartmentInfo').style.display = 'none';
                document.getElementById('kv-soldNotice').style.display = 'none';
                document.getElementById('kv-apartmentFullDetails').style.display = 'none';
                kvResetCalculation();

                if (complex && section) {
                    const apartments = kvApartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            planUrl: item["3D тур квартиры"]
                        }));

                    apartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.planUrl = apartment.planUrl || '';
                        apartmentSelect.appendChild(option);
                    });
                }
            });

            apartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('kv-selectedApartmentInfo').style.display = 'none';
                document.getElementById('kv-soldNotice').style.display = 'none';
                document.getElementById('kv-apartmentFullDetails').style.display = 'none';
                kvResetCalculation();

                if (selectedOption.value) {
                    kvCurrentBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    kvCurrentDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    kvCurrentStatus = selectedOption.dataset.status || '';
                    kvCurrentComplex = selectedOption.dataset.complex;
                    kvCurrentSection = selectedOption.dataset.section;
                    kvCurrentApartmentNumber = selectedOption.value;
                    kvCurrentRoomType = selectedOption.dataset.roomType;
                    kvCurrentArea = selectedOption.dataset.area;
                    kvCurrentPlanUrl = selectedOption.dataset.planUrl;

                    if (kvCurrentStatus === "Продано") {
                        document.getElementById('kv-soldNotice').style.display = 'block';
                        return;
                    }

                    document.getElementById('kv-apartmentDetails').innerHTML = `
                        <div>ЖК: ${kvCurrentComplex}</div>
                        <div>Дом: ${kvCurrentSection}</div>
                        <div>Квартира: ${kvCurrentApartmentNumber}</div>
                    `;
                    document.getElementById('kv-selectedApartmentInfo').style.display = 'block';

                    kvUpdateApartmentFullDetails();
                    kvUpdatePriceDisplay();
                    
                    kvCalculate();
                }
            });

            // Слушатели событий для КВ
            document.getElementById('kv-managerDiscount').addEventListener('change', kvCalculate);
            document.getElementById('kv-repairCost').addEventListener('input', kvCalculate);
            document.getElementById('kv-dduObjects').addEventListener('input', kvCalculate);
            document.getElementById('kv-kvSubsidy').addEventListener('input', kvCalculate);
            document.getElementById('kv-clientPVPercent').addEventListener('input', kvCalculate);
        }

        // Функция обновления полной информации о квартире для КВ
        function kvUpdateApartmentFullDetails() {
            document.getElementById('kv-apartmentComplex').textContent = `Жилой комплекс: ${kvCurrentComplex}`;
            document.getElementById('kv-apartmentSection').textContent = `Дом: ${kvCurrentSection}`;
            document.getElementById('kv-apartmentNumber').textContent = `Квартира: ${kvCurrentApartmentNumber}`;
            document.getElementById('kv-apartmentRooms').textContent = `Комнатность: ${getRoomTypeText(parseInt(kvCurrentRoomType))}`;
            document.getElementById('kv-apartmentArea').textContent = `Площадь: ${kvCurrentArea} м²`;
            
            if (kvCurrentPlanUrl && kvCurrentPlanUrl.trim() !== '') {
                document.getElementById('kv-apartmentPlan').innerHTML = `<a href="${kvCurrentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
            } else {
                document.getElementById('kv-apartmentPlan').innerHTML = '';
            }
            
            document.getElementById('kv-apartmentFullDetails').style.display = 'block';
        }

        // Функция обновления отображения цен для КВ
        function kvUpdatePriceDisplay() {
            document.getElementById('kv-basePriceDisplay').textContent = formatMoney(kvCurrentBasePrice);
        }

        // Функция получения скорректированной цены со скидкой (с учетом чекбокса)
        function kvGetAdjustedDiscountPrice() {
            return document.getElementById('kv-managerDiscount').checked ? 
                kvCurrentDiscountPrice : 
                kvCurrentDiscountPrice + 100000;
        }

        // Функция округления до 4 знаков (до 10000)
        function kvRoundUpTo4Digits(amount) {
            return Math.ceil(amount / 10000) * 10000;
        }
        
        // Функция расчета скидки на квартиру без учета ремонта
        function kvCalculateDiscountWithoutRepair(contractPrice, repairCost) {
            const priceWithoutRepair = contractPrice - repairCost;
            
            if (priceWithoutRepair < kvCurrentBasePrice) {
                return Math.ceil(kvCurrentBasePrice - priceWithoutRepair);
            }
            return 0;
        }
        
        // Функция сброса расчетов для КВ
        function kvResetCalculation() {
            kvCurrentBasePrice = 0;
            kvCurrentDiscountPrice = 0;
            kvCurrentStatus = '';
            kvUpdatePriceDisplay();
            
            document.getElementById('kv-familyClientPV').textContent = formatMoney(0);
            document.getElementById('kv-familyKV').textContent = formatMoney(0);
            document.getElementById('kv-familyContractPrice').textContent = formatMoney(0);
            document.getElementById('kv-familyLoanBody').textContent = formatMoney(0);
            document.getElementById('kv-familyDiscount').textContent = "Нет скидки";
            document.getElementById('kv-familyDiscount').className = "no-discount";
            document.getElementById('kv-familyWarning').style.display = 'none';
            
            document.getElementById('kv-standardClientPV').textContent = formatMoney(0);
            document.getElementById('kv-standardKV').textContent = formatMoney(0);
            document.getElementById('kv-standardContractPrice').textContent = formatMoney(0);
            document.getElementById('kv-standardLoanBody').textContent = formatMoney(0);
            document.getElementById('kv-standardDiscount').textContent = "Нет скидки";
            document.getElementById('kv-standardDiscount').className = "no-discount";
        }
        
        // Функция расчета для семейной ипотеки
        function kvCalculateFamilyMortgage() {
            const adjustedDiscountPrice = kvGetAdjustedDiscountPrice();
            const repairCost = parseInt(document.getElementById('kv-repairCost').value) || 0;
            const dduObjects = parseInt(document.getElementById('kv-dduObjects').value) || 0;
            const kvSubsidyPercent = parseFloat(document.getElementById('kv-kvSubsidy').value) || 0;
            const clientPVPercent = parseFloat(document.getElementById('kv-clientPVPercent').value) || 0;
            
            let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
            let iterations = 0;
            const maxIterations = 20;
            
            while (iterations < maxIterations) {
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                
                if (contractPrice - clientPVRub >= 6000000) {
                    document.getElementById('kv-familyWarning').style.display = 'block';
                    document.getElementById('kv-familyClientPV').textContent = "Увеличить ПВ клиента";
                    document.getElementById('kv-familyKV').textContent = formatMoney(0);
                    document.getElementById('kv-familyContractPrice').textContent = formatMoney(0);
                    document.getElementById('kv-familyLoanBody').textContent = formatMoney(0);
                    document.getElementById('kv-familyDiscount').textContent = "Нет скидки";
                    document.getElementById('kv-familyDiscount').className = "no-discount";
                    return;
                }
                
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                newContractPrice = kvRoundUpTo4Digits(newContractPrice);
                
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                
                contractPrice = newContractPrice;
                iterations++;
            }
            
            let clientPVRub = contractPrice * (clientPVPercent / 100);
            let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
            let loanBody = contractPrice - clientPVRub;
            
            if (contractPrice - clientPVRub >= 6000000) {
                document.getElementById('kv-familyWarning').style.display = 'block';
                document.getElementById('kv-familyClientPV').textContent = "Увеличить ПВ клиента";
                document.getElementById('kv-familyKV').textContent = formatMoney(0);
                document.getElementById('kv-familyContractPrice').textContent = formatMoney(0);
                document.getElementById('kv-familyLoanBody').textContent = formatMoney(0);
                document.getElementById('kv-familyDiscount').textContent = "Нет скидки";
                document.getElementById('kv-familyDiscount').className = "no-discount";
                return;
            }
            
            const discountWithoutRepair = kvCalculateDiscountWithoutRepair(contractPrice, repairCost);
            
            document.getElementById('kv-familyClientPV').textContent = formatMoney(clientPVRub);
            document.getElementById('kv-familyKV').textContent = formatMoney(kvRub);
            document.getElementById('kv-familyContractPrice').textContent = formatMoney(contractPrice);
            document.getElementById('kv-familyLoanBody').textContent = formatMoney(loanBody);
            
            if (discountWithoutRepair > 0) {
                document.getElementById('kv-familyDiscount').textContent = formatMoney(discountWithoutRepair);
                document.getElementById('kv-familyDiscount').className = "discount";
            } else {
                document.getElementById('kv-familyDiscount').textContent = "Нет скидки";
                document.getElementById('kv-familyDiscount').className = "no-discount";
            }
            
            document.getElementById('kv-familyWarning').style.display = 'none';
        }
        
        // Функция расчета для стандартной ипотеки
        function kvCalculateStandardMortgage() {
            const adjustedDiscountPrice = kvGetAdjustedDiscountPrice();
            const repairCost = parseInt(document.getElementById('kv-repairCost').value) || 0;
            const dduObjects = parseInt(document.getElementById('kv-dduObjects').value) || 0;
            const kvSubsidyPercent = parseFloat(document.getElementById('kv-kvSubsidy').value) || 0;
            const clientPVPercent = parseFloat(document.getElementById('kv-clientPVPercent').value) || 0;
            
            let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
            let iterations = 0;
            const maxIterations = 20;
            
            while (iterations < maxIterations) {
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                newContractPrice = kvRoundUpTo4Digits(newContractPrice);
                
                if (Math.abs(newContractPrice - contractPrice) < 1) {
                    break;
                }
                
                contractPrice = newContractPrice;
                iterations++;
            }
            
            let clientPVRub = contractPrice * (clientPVPercent / 100);
            let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
            let loanBody = contractPrice - clientPVRub;
            
            const discountWithoutRepair = kvCalculateDiscountWithoutRepair(contractPrice, repairCost);
            
            document.getElementById('kv-standardClientPV').textContent = formatMoney(clientPVRub);
            document.getElementById('kv-standardKV').textContent = formatMoney(kvRub);
            document.getElementById('kv-standardContractPrice').textContent = formatMoney(contractPrice);
            document.getElementById('kv-standardLoanBody').textContent = formatMoney(loanBody);
            
            if (discountWithoutRepair > 0) {
                document.getElementById('kv-standardDiscount').textContent = formatMoney(discountWithoutRepair);
                document.getElementById('kv-standardDiscount').className = "discount";
            } else {
                document.getElementById('kv-standardDiscount').textContent = "Нет скидки";
                document.getElementById('kv-standardDiscount').className = "no-discount";
            }
        }
        
        // Функция расчета для КВ
        function kvCalculate() {
            if (kvCurrentStatus === "Продано") {
                return;
            }
            
            kvCalculateFamilyMortgage();
            kvCalculateStandardMortgage();
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация событий для обоих калькуляторов
            initChpv300Events();
            initKvEvents();
            
            // Загружаем данные для активного калькулятора
            loadChpv300ApartmentsData();
        });
    </script>
</body>
</html>
