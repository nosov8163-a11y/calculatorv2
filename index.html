<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Набор калькуляторов - ПАРИТЕТ ДЕВЕЛОПМЕНТ</title>
    <style>
        /* Цветовая палитра бренда */
        :root {
            --white: #FFFFFF;
            --red: #CA0000;
            --black: #1f2022;
            --light-gray: #f5f5f5;
            --dark-gray: #333333;
            --border-color: #DADADA;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--white);
            color: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--red);
            width: 100%;
        }
        
        h1 {
            color: var(--black);
            margin: 20px 0;
            font-size: 2.2em;
        }
        
        .calculator-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .calc-button {
            background-color: var(--white);
            color: var(--black);
            border: 2px solid var(--red);
            padding: 15px 35px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 250px;
        }
        
        .calc-button:hover {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calc-button.active {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calculator-container {
            display: flex;
            gap: 40px;
            width: 100%;
            max-width: 1300px;
            justify-content: center;
        }
        
        .calculator-form {
            flex: 0 0 48%;
            background: var(--white);
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(31, 32, 34, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .calculator-results {
            flex: 0 0 48%;
            background: var(--light-gray);
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(31, 32, 34, 0.1);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--red);
        }
        
        .calculator-section {
            display: none;
            width: 100%;
            justify-content: center;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .calculator-section.active {
            display: flex;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--black);
            font-size: 1.05em;
        }
        
        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 12px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: var(--white);
            color: var(--black);
        }
        
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--red);
            box-shadow: 0 0 0 2px rgba(202, 0, 0, 0.1);
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 18px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        
        .highlight {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--red);
        }
        
        .price-comparison {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: var(--light-gray);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .discount {
            color: #28a745;
            font-weight: bold;
        }
        
        .no-discount {
            color: var(--dark-gray);
            font-weight: bold;
        }
        
        .info {
            color: var(--dark-gray);
            font-weight: bold;
        }
        
        .warning {
            color: var(--red);
            font-weight: bold;
        }
        
        .apartment-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        .sold-notice {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            border: 1px solid #f5c6cb;
        }
        
        .mortgage-block {
            margin-bottom: 35px;
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        
        .mortgage-block h3 {
            margin-top: 0;
            color: var(--black);
            border-bottom: 2px solid var(--red);
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        
        .payment-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: center;
            font-weight: bold;
            border: 1px solid #f5c6cb;
        }
        
        .apartment-details {
            margin-top: 25px;
            padding: 20px;
            background: var(--light-gray);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .apartment-details h3 {
            margin-top: 0;
            color: var(--black);
            margin-bottom: 15px;
        }
        
        .apartment-details div {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        h2 {
            margin-top: 0;
            color: var(--black);
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        
        .plan-button {
            background-color: var(--red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }
        
        .plan-button:hover {
            background-color: #a80000;
        }
        
        .plan-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .additional-costs {
            background: var(--light-gray);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        
        .manager-discount {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        
        .bank-discount {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 15px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .input-with-slider {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .manual-input {
            width: 150px;
        }
        
        .term-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 8px;
        }
        
        .min-payment-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 8px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
            display: inline-block;
        }
        
        .complex-display {
            padding: 10px;
            background: #f8d7da;
            border-radius: 6px;
            border: 1px solid var(--red);
            font-weight: bold;
            color: #721c24;
        }
        
        /* Стили для сворачиваемых блоков */
        .options-container {
            background: var(--light-gray);
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .options-header {
            padding: 18px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--black);
            background: #e9ecef;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        
        .options-header:hover {
            background: #dee2e6;
        }
        
        .options-icon {
            transition: transform 0.3s;
            color: var(--red);
            font-size: 1.2em;
        }
        
        .options-content {
            padding: 25px;
            display: block;
        }
        
        .options-content.collapsed {
            display: none;
        }
        
        .options-icon.rotated {
            transform: rotate(180deg);
        }
        
        .option-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .option-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .option-title {
            font-weight: bold;
            color: var(--black);
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        .option-description {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 8px;
        }
        
        .commission-input-container {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
            display: none;
        }
        
        /* Стили для КВ результатов в форме */
        .kv-results {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .kv-result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
        /* Стиль для даты и времени расчета */
        .calculation-time {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            color: var(--dark-gray);
            font-size: 0.9em;
            text-align: center;
        }
        
        .calculation-time .time-value {
            font-weight: bold;
            color: var(--black);
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 10px;
            border-radius: 6px;
            background: #d1d1d1;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        /* Адаптивность */
        @media (max-width: 992px) {
            .calculator-container {
                flex-direction: column;
                gap: 30px;
            }
            
            .calculator-form, .calculator-results {
                flex: 1 1 100%;
            }
            
            .calculator-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .calc-button {
                width: 100%;
                max-width: 400px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .calculator-form, .calculator-results {
                padding: 25px;
            }
            
            .mortgage-block {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            h2 {
                font-size: 1.5em;
            }
        }
        
        @media (max-width: 480px) {
            .calculator-form, .calculator-results {
                padding: 20px;
            }
            
            .calc-button {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Набор калькуляторов</h1>
        <div class="calculator-buttons">
            <button class="calc-button active" data-calc="chpv2">Калькулятор ЧПВ 2.0</button>
            <button class="calc-button" data-calc="kv">Расчет КВ</button>
        </div>
    </div>

    <!-- Калькулятор ЧПВ 2.0 -->
    <div id="chpv2-calculator" class="calculator-section active">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор ЧПВ 2.0</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="chpv2-complexSelect">Жилой комплекс:</label>
                    <select id="chpv2-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv2-sectionSelect">Название дома:</label>
                    <select id="chpv2-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv2-apartmentSelect">Квартира:</label>
                    <select id="chpv2-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="chpv2-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="chpv2-apartmentDetails"></div>
                </div>

                <div id="chpv2-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <!-- Цена квартиры -->
                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="chpv2-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <!-- Блок Опции (сворачиваемый) -->
                <div class="options-container">
                    <div class="options-header" id="chpv2-optionsHeader">
                        <span>Опции</span>
                        <span class="options-icon">▼</span>
                    </div>
                    <div class="options-content" id="chpv2-optionsContent">
                        <!-- Скидка менеджера -->
                        <div class="option-section">
                            <div class="option-title">Скидка менеджера</div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="chpv2-managerDiscount">
                                <label for="chpv2-managerDiscount">Применить скидку менеджера</label>
                            </div>
                            <div class="option-description">
                                При включенной скидке менеджера цена уменьшается на 100,000 ₽
                            </div>
                        </div>
                        
                        <!-- Комиссия банка -->
                        <div class="option-section">
                            <div class="option-title">Комиссия банка</div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="chpv2-bankDiscount">
                                <label for="chpv2-bankDiscount">Применить комиссию банка</label>
                            </div>
                            <div class="option-description">
                                При включении добавляется комиссия банка от тела кредита (по умолчанию 9,5%)
                            </div>
                            <div id="chpv2-commissionInputContainer" class="commission-input-container">
                                <div class="form-group">
                                    <label for="chpv2-bankCommissionPercent">Процент комиссии банка (%):</label>
                                    <input type="number" id="chpv2-bankCommissionPercent" value="9.5" min="0" max="100" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Дополнительные расходы -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="chpv2-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="chpv2-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="chpv2-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="chpv2-dduObjects" value="0" min="0" step="10000">
                    </div>
                </div>
                
                <!-- Первоначальный взнос клиента -->
                <div class="form-group">
                    <label for="chpv2-clientDownPayment">Первоначальный взнос клиента (₽):</label>
                    <input type="number" id="chpv2-clientDownPayment" value="0" min="0" step="10000">
                    <div id="chpv2-minPaymentInfo" class="min-payment-info"></div>
                </div>
                
                <div id="chpv2-paymentWarning" class="payment-warning" style="display: none;">
                    Первоначальный взнос клиента меньше минимального требуемого!
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                <div class="result-item">
                    <span>Стоимость договора для ДДУ:</span>
                    <span id="chpv2-resultContractPrice" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Общий ПВ:</span>
                    <span id="chpv2-resultTotalPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Паритет ПВ:</span>
                    <span id="chpv2-resultCompanyPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Клиента ПВ:</span>
                    <span id="chpv2-resultClientPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Тело кредита:</span>
                    <span id="chpv2-resultLoanBody" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Процент ПВ:</span>
                    <span id="chpv2-resultPVPercent" class="highlight">0%</span>
                </div>
                <div id="chpv2-bankCommissionItem" class="result-item" style="display: none;">
                    <span>Комиссия банка:</span>
                    <span id="chpv2-resultBankCommission" class="info">0 ₽</span>
                </div>
                <div id="chpv2-bankCommissionPercentItem" class="result-item" style="display: none;">
                    <span>Процент комиссии:</span>
                    <span id="chpv2-resultBankCommissionPercent" class="info">0%</span>
                </div>
                <div class="result-item">
                    <span>Скидка на квартиру без учета ремонта:</span>
                    <span id="chpv2-resultDiscountWithoutRepair" class="no-discount">Нет скидки</span>
                </div>
                
                <!-- Дата и время расчета для ЧПВ 2.0 -->
                <div id="chpv2-calculationTime" class="calculation-time" style="display: none;">
                    Расчет выполнен: <span class="time-value" id="chpv2-timeValue">-</span>
                </div>
                
                <div id="chpv2-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="chpv2-apartmentComplex"></div>
                    <div id="chpv2-apartmentSection"></div>
                    <div id="chpv2-apartmentNumber"></div>
                    <div id="chpv2-apartmentRooms"></div>
                    <div id="chpv2-apartmentArea"></div>
                    <div id="chpv2-apartmentFloor"></div>
                    <div id="chpv2-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Калькулятор КВ -->
    <div id="kv-calculator" class="calculator-section">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Расчет КВ</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="kv-complexSelect">Жилой комплекс:</label>
                    <select id="kv-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-sectionSelect">Название дома:</label>
                    <select id="kv-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-apartmentSelect">Квартира:</label>
                    <select id="kv-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="kv-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="kv-apartmentDetails"></div>
                </div>

                <div id="kv-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <!-- Убрана цена со скидкой из отображения -->
                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="kv-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <!-- Вынесенные поля из сворачиваемой части -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="kv-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="kv-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-kvSubsidy">Субсидия КВ в %:</label>
                        <input type="number" id="kv-kvSubsidy" value="4.5" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="kv-dduObjects" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-clientPVPercent">ПВ клиента (%):</label>
                        <input type="number" id="kv-clientPVPercent" value="20.1" min="0" step="0.1">
                    </div>
                </div>
                
                <!-- Кнопка для разворачивания опций -->
                <div class="options-container">
                    <div class="options-header" id="kv-optionsHeader">
                        <span>Опции</span>
                        <span class="options-icon">▼</span>
                    </div>
                    <div class="options-content collapsed" id="kv-optionsContent">
                        <!-- Чекбокс скидки менеджера -->
                        <div class="option-section">
                            <div class="option-title">Скидка менеджера</div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="kv-managerDiscount">
                                <label for="kv-managerDiscount">Применить скидку менеджера</label>
                            </div>
                            <div class="option-description">
                                При включенной скидке менеджера цена уменьшается на 100,000 ₽
                            </div>
                        </div>
                        
                        <!-- Результаты КВ (перенесены сюда) -->
                        <div class="kv-results">
                            <h4>КВ рублей:</h4>
                            <div class="kv-result-item">
                                <span>Семейная ипотека:</span>
                                <span id="kv-familyKV" class="highlight">0 ₽</span>
                            </div>
                            <div class="kv-result-item">
                                <span>Стандартная ипотека:</span>
                                <span id="kv-standardKV" class="highlight">0 ₽</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                
                <!-- Блок для семейной ипотеки -->
                <div class="mortgage-block">
                    <h3>Семейная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-familyClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-familyContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-familyLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-familyDiscount" class="no-discount">Нет скидки</span>
                    </div>
                    <div id="kv-familyWarning" class="payment-warning" style="display: none;">
                        Увеличить ПВ клиента
                    </div>
                </div>
                
                <!-- Блок для стандартной ипотеки -->
                <div class="mortgage-block">
                    <h3>Стандартная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-standardClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-standardContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-standardLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-standardDiscount" class="no-discount">Нет скидки</span>
                    </div>
                </div>
                
                <!-- Дата и время расчета для КВ -->
                <div id="kv-calculationTime" class="calculation-time" style="display: none;">
                    Расчет выполнен: <span class="time-value" id="kv-timeValue">-</span>
                </div>
                
                <div id="kv-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="kv-apartmentComplex"></div>
                    <div id="kv-apartmentSection"></div>
                    <div id="kv-apartmentNumber"></div>
                    <div id="kv-apartmentRooms"></div>
                    <div id="kv-apartmentArea"></div>
                    <div id="kv-apartmentFloor"></div>
                    <div id="kv-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Общие функции
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVMdD1qLq8N3hBj1OV-xVXz5T9wwOcDTPSa09j5Ty7kxm7YY1SErU5fXkoqWxO2zZ2/exec';

        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ₽';
        }

        function getRoomTypeText(roomType) {
            const roomTypes = {
                0: 'Студия',
                1: '1-комнатная',
                2: '2-комнатная',
                3: '3-комнатная'
            };
            return roomTypes[roomType] || 'Неизвестно';
        }

        // Функция для форматирования даты и времени
        function getCurrentDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            return now.toLocaleDateString('ru-RU', options);
        }

        // Функция для обновления времени расчета
        function updateCalculationTime(elementId) {
            const timeElement = document.getElementById(elementId);
            if (timeElement) {
                timeElement.textContent = getCurrentDateTime();
                timeElement.parentElement.style.display = 'block';
            }
        }

        // Переключение между калькуляторами
        const calculatorButtons = document.querySelectorAll('.calc-button');
        const calculatorSections = document.querySelectorAll('.calculator-section');

        calculatorButtons.forEach(button => {
            button.addEventListener('click', () => {
                const calculatorId = button.getAttribute('data-calc');
                
                // Убираем активный класс у всех кнопок
                calculatorButtons.forEach(btn => btn.classList.remove('active'));
                // Добавляем активный класс текущей кнопке
                button.classList.add('active');
                
                // Скрываем все калькуляторы
                calculatorSections.forEach(section => section.classList.remove('active'));
                // Показываем выбранный калькулятор
                document.getElementById(`${calculatorId}-calculator`).classList.add('active');
            });
        });

        // Глобальные данные квартир
        let allApartmentsData = [];

        // Загрузка всех данных при запуске
        async function loadAllApartmentsData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                // Фильтруем только квартиры и исключаем статус "Субаренда (продано)"
                allApartmentsData = data.filter(item => {
                    const isApartment = item["Тип помещения"] && item["Тип помещения"].toLowerCase() === "квартира";
                    const isNotSubRent = item["Статус"] !== "Субаренда (продано)";
                    return isApartment && isNotSubRent;
                });
                
                // После загрузки данных инициализируем оба калькулятора
                if (document.getElementById('chpv2-calculator')) {
                    initializeChpv2Calculator();
                }
                
                if (document.getElementById('kv-calculator')) {
                    initializeKvCalculator();
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                // Показываем ошибку в обоих селектах
                document.getElementById('chpv2-complexSelect').innerHTML = '<option value="">Ошибка загрузки данных</option>';
                document.getElementById('kv-complexSelect').innerHTML = '<option value="">Ошибка загрузки данных</option>';
            }
        }

        // ==================== КАЛЬКУЛЯТОР ЧПВ 2.0 ====================
        function initializeChpv2Calculator() {
            // Элементы DOM для ЧПВ 2.0
            const chpv2 = {
                complexSelect: document.getElementById('chpv2-complexSelect'),
                sectionSelect: document.getElementById('chpv2-sectionSelect'),
                apartmentSelect: document.getElementById('chpv2-apartmentSelect'),
                selectedApartmentInfo: document.getElementById('chpv2-selectedApartmentInfo'),
                apartmentDetails: document.getElementById('chpv2-apartmentDetails'),
                soldNotice: document.getElementById('chpv2-soldNotice'),
                basePriceDisplay: document.getElementById('chpv2-basePriceDisplay'),
                managerDiscountCheckbox: document.getElementById('chpv2-managerDiscount'),
                bankDiscountCheckbox: document.getElementById('chpv2-bankDiscount'),
                commissionInputContainer: document.getElementById('chpv2-commissionInputContainer'),
                bankCommissionPercentInput: document.getElementById('chpv2-bankCommissionPercent'),
                repairCostInput: document.getElementById('chpv2-repairCost'),
                dduObjectsInput: document.getElementById('chpv2-dduObjects'),
                clientDownPaymentInput: document.getElementById('chpv2-clientDownPayment'),
                minPaymentInfo: document.getElementById('chpv2-minPaymentInfo'),
                paymentWarning: document.getElementById('chpv2-paymentWarning'),
                apartmentFullDetails: document.getElementById('chpv2-apartmentFullDetails'),
                optionsHeader: document.getElementById('chpv2-optionsHeader'),
                optionsContent: document.getElementById('chpv2-optionsContent'),
                calculationTime: document.getElementById('chpv2-calculationTime'),
                timeValue: document.getElementById('chpv2-timeValue'),
                
                // Результаты
                resultContractPrice: document.getElementById('chpv2-resultContractPrice'),
                resultTotalPV: document.getElementById('chpv2-resultTotalPV'),
                resultCompanyPV: document.getElementById('chpv2-resultCompanyPV'),
                resultClientPV: document.getElementById('chpv2-resultClientPV'),
                resultLoanBody: document.getElementById('chpv2-resultLoanBody'),
                resultPVPercent: document.getElementById('chpv2-resultPVPercent'),
                bankCommissionItem: document.getElementById('chpv2-bankCommissionItem'),
                bankCommissionPercentItem: document.getElementById('chpv2-bankCommissionPercentItem'),
                resultBankCommission: document.getElementById('chpv2-resultBankCommission'),
                resultBankCommissionPercent: document.getElementById('chpv2-resultBankCommissionPercent'),
                resultDiscountWithoutRepair: document.getElementById('chpv2-resultDiscountWithoutRepair'),
                
                // Информация о квартире
                apartmentComplex: document.getElementById('chpv2-apartmentComplex'),
                apartmentSection: document.getElementById('chpv2-apartmentSection'),
                apartmentNumber: document.getElementById('chpv2-apartmentNumber'),
                apartmentRooms: document.getElementById('chpv2-apartmentRooms'),
                apartmentArea: document.getElementById('chpv2-apartmentArea'),
                apartmentFloor: document.getElementById('chpv2-apartmentFloor'),
                apartmentPlan: document.getElementById('chpv2-apartmentPlan'),
                
                // Текущие данные
                currentBasePrice: 0,
                currentOriginalBasePrice: 0,
                currentDiscountPrice: 0,
                currentOriginalDiscountPrice: 0,
                currentStatus: '',
                currentComplex: '',
                currentSection: '',
                currentApartmentNumber: '',
                currentRoomType: '',
                currentArea: '',
                currentFloor: '',
                currentPlanUrl: ''
            };

            // ЖК с увеличенной ценой на 3% (только для цены со скидкой)
            const increasedPriceComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
            const PRICE_INCREASE_RATE = 0.03; // 3%

            // Коэффициенты для расчета минимального ПВ
            const coefficients = {
                'АСТРО': [
                    { max: 5000000, value: 0.10 },
                    { max: 8000000, value: 0.12 },
                    { max: 12000000, value: 0.15 }
                ],
                'ЧИСТЫЕ ПРУДЫ': [
                    { max: 5000000, value: 0.095 },
                    { max: 8000000, value: 0.105 },
                    { max: 14000000, value: 0.135 }
                ],
                'Счастье': [
                    { max: 2000000, value: 0.065 },
                    { max: 3500000, value: 0.09 },
                    { max: 6500000, value: 0.11 }
                ],
                'Тёплые кварталы': [
                    { max: 5000000, value: 0.105 },
                    { max: 8000000, value: 0.125 },
                    { max: 14000000, value: 0.145 }
                ],
                'Бодровский': [
                    { max: 5000000, value: 0.10 },
                    { max: 8000000, value: 0.12 },
                    { max: 14000000, value: 0.14 }
                ],
                'Комсомольский': [
                    { max: 5000000, value: 0.10 },
                    { max: 8000000, value: 0.12 },
                    { max: 14000000, value: 0.14 }
                ]
            };

            // ЖК с фиксированным минимальным ПВ 300 000 ₽
            const fixedMinPaymentComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
            const FIXED_MIN_PAYMENT = 300000;

            // Функция для получения коэффициента для ЖК
            function getCoefficient(complex, basePrice) {
                const complexCoeffs = coefficients[complex];
                if (!complexCoeffs) return 0.10;
                
                for (let i = 0; i < complexCoeffs.length; i++) {
                    if (basePrice <= complexCoeffs[i].max) {
                        return complexCoeffs[i].value;
                    }
                }
                
                return complexCoeffs[complexCoeffs.length - 1].value;
            }

            // Функция проверки, является ли ЖК с фиксированным минимальным ПВ
            function isFixedMinPaymentComplex(complex) {
                return fixedMinPaymentComplexes.includes(complex);
            }

            // Функция проверки, нужно ли увеличивать цену со скидкой для ЖК
            function isPriceIncreasedComplex(complex) {
                return increasedPriceComplexes.includes(complex);
            }

            // Функция расчета минимального ПВ клиента
            function calculateMinClientPayment() {
                if (isFixedMinPaymentComplex(chpv2.currentComplex)) {
                    return FIXED_MIN_PAYMENT;
                }
                
                const repairCost = parseInt(chpv2.repairCostInput.value) || 0;
                const dduObjects = parseInt(chpv2.dduObjectsInput.value) || 0;
                const totalBase = chpv2.currentBasePrice + repairCost + dduObjects;
                const coefficient = getCoefficient(chpv2.currentComplex, chpv2.currentBasePrice);
                
                return Math.round(totalBase * coefficient);
            }

            // Функция сворачивания/разворачивания блока Опции
            function setupChpv2OptionsCollapsible() {
                chpv2.optionsHeader.addEventListener('click', function() {
                    const isCollapsed = chpv2.optionsContent.classList.toggle('collapsed');
                    const icon = this.querySelector('.options-icon');
                    if (isCollapsed) {
                        icon.classList.remove('rotated');
                    } else {
                        icon.classList.add('rotated');
                    }
                });
            }

            // Функция получения скорректированной цены со скидкой
            function getAdjustedDiscountPrice() {
                return chpv2.managerDiscountCheckbox.checked ? 
                    chpv2.currentDiscountPrice : 
                    chpv2.currentDiscountPrice + 100000;
            }

            // Функция получения текущей комиссии банка
            function getBankCommissionRate() {
                if (!chpv2.bankDiscountCheckbox.checked) return 0;
                const commissionPercent = parseFloat(chpv2.bankCommissionPercentInput.value) || 9.5;
                return commissionPercent / 100;
            }
            
            // Функция расчета стоимости договора для ДДУ БЕЗ комиссии банка
            function calculateContractPriceWithoutBankCommission() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(chpv2.repairCostInput.value) || 0;
                const dduObjects = parseInt(chpv2.dduObjectsInput.value) || 0;
                const clientPV = parseInt(chpv2.clientDownPaymentInput.value) || 0;
                
                let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
                
                for (let i = 0; i < 20; i++) {
                    let totalPV = Math.ceil(contractPrice * 0.201);
                    let companyPV = totalPV - clientPV;
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + companyPV + companyPV * 0.05;
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    contractPrice = newContractPrice;
                }
                
                return Math.round(contractPrice);
            }
            
            // Функция расчета стоимости договора для ДДУ С комиссией банка
            function calculateContractPriceWithBankCommission() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(chpv2.repairCostInput.value) || 0;
                const dduObjects = parseInt(chpv2.dduObjectsInput.value) || 0;
                const clientPV = parseInt(chpv2.clientDownPaymentInput.value) || 0;
                const bankCommissionRate = getBankCommissionRate();
                
                let contractPrice = calculateContractPriceWithoutBankCommission();
                let bankCommission = 0;
                
                for (let i = 0; i < 20; i++) {
                    let totalPV = Math.ceil(contractPrice * 0.201);
                    let companyPV = totalPV - clientPV;
                    let loanBody = contractPrice - totalPV;
                    
                    bankCommission = Math.round(loanBody * bankCommissionRate);
                    
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + companyPV + companyPV * 0.05 + bankCommission;
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    contractPrice = newContractPrice;
                }
                
                return {
                    contractPrice: Math.round(contractPrice),
                    bankCommission: bankCommission,
                    bankCommissionRate: bankCommissionRate
                };
            }
            
            // Функция расчета скидки на квартиру без учета ремонта
            function calculateDiscountWithoutRepair(contractPrice) {
                const repairCost = parseInt(chpv2.repairCostInput.value) || 0;
                const priceWithoutRepair = contractPrice - repairCost;
                
                if (priceWithoutRepair < chpv2.currentBasePrice) {
                    return Math.ceil(chpv2.currentBasePrice - priceWithoutRepair);
                }
                return 0;
            }
            
            // Функция сброса расчетов
            function resetChpv2Calculation() {
                chpv2.currentBasePrice = 0;
                chpv2.currentOriginalBasePrice = 0;
                chpv2.currentDiscountPrice = 0;
                chpv2.currentOriginalDiscountPrice = 0;
                chpv2.currentStatus = '';
                chpv2.currentFloor = '';
                chpv2.basePriceDisplay.textContent = formatMoney(0);
                
                chpv2.resultContractPrice.textContent = formatMoney(0);
                chpv2.resultTotalPV.textContent = formatMoney(0);
                chpv2.resultCompanyPV.textContent = formatMoney(0);
                chpv2.resultClientPV.textContent = formatMoney(0);
                chpv2.resultLoanBody.textContent = formatMoney(0);
                chpv2.resultPVPercent.textContent = "0%";
                chpv2.resultBankCommission.textContent = formatMoney(0);
                chpv2.resultBankCommissionPercent.textContent = "0%";
                chpv2.bankCommissionItem.style.display = 'none';
                chpv2.bankCommissionPercentItem.style.display = 'none';
                chpv2.resultDiscountWithoutRepair.textContent = "Нет скидки";
                chpv2.resultDiscountWithoutRepair.className = "no-discount";
                
                chpv2.minPaymentInfo.textContent = '';
                chpv2.paymentWarning.style.display = 'none';
                chpv2.calculationTime.style.display = 'none';
            }
            
            // Функция обновления полной информации о квартире
            function updateChpv2ApartmentFullDetails() {
                chpv2.apartmentComplex.textContent = `Жилой комплекс: ${chpv2.currentComplex}`;
                chpv2.apartmentSection.textContent = `Дом: ${chpv2.currentSection}`;
                chpv2.apartmentNumber.textContent = `Квартира: ${chpv2.currentApartmentNumber}`;
                chpv2.apartmentRooms.textContent = `Комнатность: ${getRoomTypeText(parseInt(chpv2.currentRoomType))}`;
                chpv2.apartmentArea.textContent = `Площадь: ${chpv2.currentArea} м²`;
                chpv2.apartmentFloor.textContent = `Этаж: ${chpv2.currentFloor}`;
                
                if (chpv2.currentPlanUrl && chpv2.currentPlanUrl.trim() !== '') {
                    chpv2.apartmentPlan.innerHTML = `<a href="${chpv2.currentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
                } else {
                    chpv2.apartmentPlan.innerHTML = '';
                }
                
                chpv2.apartmentFullDetails.style.display = 'block';
            }
            
            // Функция обновления отображения цен
            function updateChpv2PriceDisplay() {
                chpv2.basePriceDisplay.textContent = formatMoney(chpv2.currentBasePrice);
            }
            
            // Функция расчета для ЧПВ 2.0
            function calculateChpv2() {
                if (chpv2.currentStatus === "Продано") {
                    return;
                }
                
                const clientPV = parseInt(chpv2.clientDownPaymentInput.value) || 0;
                const forBank = chpv2.bankDiscountCheckbox.checked;
                
                const minClientPayment = calculateMinClientPayment();
                
                if (isFixedMinPaymentComplex(chpv2.currentComplex)) {
                    chpv2.minPaymentInfo.textContent = `Минимальный первоначальный взнос: ${formatMoney(FIXED_MIN_PAYMENT)}`;
                } else {
                    const coefficient = getCoefficient(chpv2.currentComplex, chpv2.currentBasePrice);
                    chpv2.minPaymentInfo.textContent = `Минимальный первоначальный взнос: ${formatMoney(minClientPayment)}`;
                }
                
                if (clientPV < minClientPayment) {
                    chpv2.paymentWarning.style.display = 'block';
                    const amountToAdd = minClientPayment - clientPV;
                    chpv2.paymentWarning.textContent = `Первоначальный взнос клиента меньше минимального требуемого! Необходимо добавить еще ${formatMoney(amountToAdd)}`;
                    
                    chpv2.resultContractPrice.textContent = formatMoney(0);
                    chpv2.resultTotalPV.textContent = formatMoney(0);
                    chpv2.resultCompanyPV.textContent = formatMoney(0);
                    chpv2.resultClientPV.textContent = formatMoney(clientPV);
                    chpv2.resultLoanBody.textContent = formatMoney(0);
                    chpv2.resultPVPercent.textContent = "0%";
                    chpv2.resultBankCommission.textContent = formatMoney(0);
                    chpv2.resultBankCommissionPercent.textContent = "0%";
                    chpv2.bankCommissionItem.style.display = 'none';
                    chpv2.bankCommissionPercentItem.style.display = 'none';
                    chpv2.resultDiscountWithoutRepair.textContent = "Нет скидки";
                    chpv2.resultDiscountWithoutRepair.className = "no-discount";
                    chpv2.calculationTime.style.display = 'none';
                    return;
                } else {
                    chpv2.paymentWarning.style.display = 'none';
                }
                
                let contractPrice, bankCommission, bankCommissionRate;
                
                if (forBank) {
                    const calculationResult = calculateContractPriceWithBankCommission();
                    contractPrice = calculationResult.contractPrice;
                    bankCommission = calculationResult.bankCommission;
                    bankCommissionRate = calculationResult.bankCommissionRate;
                } else {
                    contractPrice = calculateContractPriceWithoutBankCommission();
                    bankCommission = 0;
                    bankCommissionRate = 0;
                }
                
                const totalPV = Math.ceil(contractPrice * 0.201);
                const companyPV = totalPV - clientPV;
                const loanBody = contractPrice - totalPV;
                const pvPercent = (totalPV / contractPrice * 100).toFixed(6);
                const discountWithoutRepair = calculateDiscountWithoutRepair(contractPrice);
                
                chpv2.resultContractPrice.textContent = formatMoney(contractPrice);
                chpv2.resultTotalPV.textContent = formatMoney(totalPV);
                chpv2.resultCompanyPV.textContent = formatMoney(companyPV);
                chpv2.resultClientPV.textContent = formatMoney(clientPV);
                chpv2.resultLoanBody.textContent = formatMoney(loanBody);
                chpv2.resultPVPercent.textContent = `${pvPercent}%`;
                
                if (forBank) {
                    chpv2.resultBankCommission.textContent = formatMoney(bankCommission);
                    chpv2.resultBankCommissionPercent.textContent = `${(bankCommissionRate * 100).toFixed(1)}%`;
                    chpv2.bankCommissionItem.style.display = 'flex';
                    chpv2.bankCommissionPercentItem.style.display = 'flex';
                } else {
                    chpv2.bankCommissionItem.style.display = 'none';
                    chpv2.bankCommissionPercentItem.style.display = 'none';
                }
                
                if (discountWithoutRepair > 0) {
                    chpv2.resultDiscountWithoutRepair.textContent = formatMoney(discountWithoutRepair);
                    chpv2.resultDiscountWithoutRepair.className = "discount";
                } else {
                    chpv2.resultDiscountWithoutRepair.textContent = "Нет скидки";
                    chpv2.resultDiscountWithoutRepair.className = "no-discount";
                }
                
                // Обновляем время расчета
                updateCalculationTime('chpv2-timeValue');
            }

            // Заполнение списка ЖК для ЧПВ 2.0
            function populateChpv2Complexes() {
                const complexes = [...new Set(allApartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
                chpv2.complexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
                complexes.forEach(complex => {
                    const option = document.createElement('option');
                    option.value = complex;
                    option.textContent = complex;
                    chpv2.complexSelect.appendChild(option);
                });
            }

            // События для ЧПВ 2.0
            chpv2.complexSelect.addEventListener('change', function() {
                const complex = this.value;
                chpv2.sectionSelect.disabled = !complex;
                chpv2.apartmentSelect.disabled = true;
                chpv2.apartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                chpv2.selectedApartmentInfo.style.display = 'none';
                chpv2.soldNotice.style.display = 'none';
                chpv2.apartmentFullDetails.style.display = 'none';
                resetChpv2Calculation();

                if (complex) {
                    // Фильтруем данные по выбранному ЖК
                    const apartmentsData = allApartmentsData.filter(item => item["Название ЖК"] === complex);
                    
                    const sections = [...new Set(apartmentsData
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    chpv2.sectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        chpv2.sectionSelect.appendChild(option);
                    });
                    
                    chpv2.sectionSelect.disabled = false;
                }
            });

            chpv2.sectionSelect.addEventListener('change', function() {
                const complex = chpv2.complexSelect.value;
                const section = this.value;
                chpv2.apartmentSelect.disabled = !section;
                chpv2.selectedApartmentInfo.style.display = 'none';
                chpv2.soldNotice.style.display = 'none';
                chpv2.apartmentFullDetails.style.display = 'none';
                resetChpv2Calculation();

                if (complex && section) {
                    // Фильтруем данные по выбранному ЖК и дому
                    const apartments = allApartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            floor: item["Этаж"] || '',
                            planUrl: item["3D тур квартиры"]
                        }));

                    chpv2.apartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.floor = apartment.floor || '';
                        option.dataset.planUrl = apartment.planUrl || '';
                        chpv2.apartmentSelect.appendChild(option);
                    });
                    
                    chpv2.apartmentSelect.disabled = false;
                }
            });

            chpv2.apartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                chpv2.selectedApartmentInfo.style.display = 'none';
                chpv2.soldNotice.style.display = 'none';
                chpv2.apartmentFullDetails.style.display = 'none';
                resetChpv2Calculation();

                if (selectedOption.value) {
                    chpv2.currentOriginalBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    chpv2.currentOriginalDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    chpv2.currentStatus = selectedOption.dataset.status || '';
                    chpv2.currentComplex = selectedOption.dataset.complex;
                    chpv2.currentSection = selectedOption.dataset.section;
                    chpv2.currentApartmentNumber = selectedOption.value;
                    chpv2.currentRoomType = selectedOption.dataset.roomType;
                    chpv2.currentArea = selectedOption.dataset.area;
                    chpv2.currentFloor = selectedOption.dataset.floor || '';
                    chpv2.currentPlanUrl = selectedOption.dataset.planUrl;

                    chpv2.currentBasePrice = chpv2.currentOriginalBasePrice;
                    
                    if (isPriceIncreasedComplex(chpv2.currentComplex)) {
                        chpv2.currentDiscountPrice = Math.round(chpv2.currentOriginalDiscountPrice * (1 + PRICE_INCREASE_RATE));
                    } else {
                        chpv2.currentDiscountPrice = chpv2.currentOriginalDiscountPrice;
                    }

                    if (chpv2.currentStatus === "Продано") {
                        chpv2.soldNotice.style.display = 'block';
                        return;
                    }

                    chpv2.apartmentDetails.innerHTML = `
                        <div>ЖК: ${chpv2.currentComplex}</div>
                        <div>Дом: ${chpv2.currentSection}</div>
                        <div>Квартира: ${chpv2.currentApartmentNumber}</div>
                    `;
                    chpv2.selectedApartmentInfo.style.display = 'block';

                    updateChpv2ApartmentFullDetails();
                    updateChpv2PriceDisplay();
                    calculateChpv2();
                }
            });

            // Слушатели событий для ЧПВ 2.0
            chpv2.managerDiscountCheckbox.addEventListener('change', function() {
                updateChpv2PriceDisplay();
                calculateChpv2();
            });
            
            chpv2.bankDiscountCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    chpv2.commissionInputContainer.style.display = 'block';
                } else {
                    chpv2.commissionInputContainer.style.display = 'none';
                }
                calculateChpv2();
            });
            
            chpv2.bankCommissionPercentInput.addEventListener('input', calculateChpv2);
            chpv2.repairCostInput.addEventListener('input', calculateChpv2);
            chpv2.dduObjectsInput.addEventListener('input', calculateChpv2);
            chpv2.clientDownPaymentInput.addEventListener('input', calculateChpv2);

            // Инициализация ЧПВ 2.0
            populateChpv2Complexes();
            setupChpv2OptionsCollapsible();
        }

        // ==================== КАЛЬКУЛЯТОР КВ ====================
        function initializeKvCalculator() {
            // Элементы DOM для КВ
            const kv = {
                complexSelect: document.getElementById('kv-complexSelect'),
                sectionSelect: document.getElementById('kv-sectionSelect'),
                apartmentSelect: document.getElementById('kv-apartmentSelect'),
                selectedApartmentInfo: document.getElementById('kv-selectedApartmentInfo'),
                apartmentDetails: document.getElementById('kv-apartmentDetails'),
                soldNotice: document.getElementById('kv-soldNotice'),
                basePriceDisplay: document.getElementById('kv-basePriceDisplay'),
                managerDiscountCheckbox: document.getElementById('kv-managerDiscount'),
                repairCostInput: document.getElementById('kv-repairCost'),
                dduObjectsInput: document.getElementById('kv-dduObjects'),
                kvSubsidyInput: document.getElementById('kv-kvSubsidy'),
                clientPVPercentInput: document.getElementById('kv-clientPVPercent'),
                apartmentFullDetails: document.getElementById('kv-apartmentFullDetails'),
                optionsHeader: document.getElementById('kv-optionsHeader'),
                optionsContent: document.getElementById('kv-optionsContent'),
                calculationTime: document.getElementById('kv-calculationTime'),
                timeValue: document.getElementById('kv-timeValue'),
                
                // Результаты для семейной ипотеки
                familyClientPV: document.getElementById('kv-familyClientPV'),
                familyKV: document.getElementById('kv-familyKV'),
                familyContractPrice: document.getElementById('kv-familyContractPrice'),
                familyLoanBody: document.getElementById('kv-familyLoanBody'),
                familyDiscount: document.getElementById('kv-familyDiscount'),
                familyWarning: document.getElementById('kv-familyWarning'),
                
                // Результаты для стандартной ипотеки
                standardClientPV: document.getElementById('kv-standardClientPV'),
                standardKV: document.getElementById('kv-standardKV'),
                standardContractPrice: document.getElementById('kv-standardContractPrice'),
                standardLoanBody: document.getElementById('kv-standardLoanBody'),
                standardDiscount: document.getElementById('kv-standardDiscount'),
                
                // Информация о квартире
                apartmentComplex: document.getElementById('kv-apartmentComplex'),
                apartmentSection: document.getElementById('kv-apartmentSection'),
                apartmentNumber: document.getElementById('kv-apartmentNumber'),
                apartmentRooms: document.getElementById('kv-apartmentRooms'),
                apartmentArea: document.getElementById('kv-apartmentArea'),
                apartmentFloor: document.getElementById('kv-apartmentFloor'),
                apartmentPlan: document.getElementById('kv-apartmentPlan'),

                // Текущие данные
                currentBasePrice: 0,
                currentDiscountPrice: 0,
                currentStatus: '',
                currentComplex: '',
                currentSection: '',
                currentApartmentNumber: '',
                currentRoomType: '',
                currentArea: '',
                currentFloor: '',
                currentPlanUrl: ''
            };

            // Функция сворачивания/разворачивания блока Опции
            function setupKvOptionsCollapsible() {
                kv.optionsHeader.addEventListener('click', function() {
                    const isCollapsed = kv.optionsContent.classList.toggle('collapsed');
                    const icon = this.querySelector('.options-icon');
                    if (isCollapsed) {
                        icon.classList.remove('rotated');
                    } else {
                        icon.classList.add('rotated');
                    }
                });
            }

            // Функция получения скорректированной цены со скидкой
            function getAdjustedDiscountPrice() {
                return kv.managerDiscountCheckbox.checked ? 
                    kv.currentDiscountPrice : 
                    kv.currentDiscountPrice + 100000;
            }

            // Функция округления до 4 знаков (до 10000)
            function roundUpTo4Digits(amount) {
                return Math.ceil(amount / 10000) * 10000;
            }
            
            // Функция расчета скидки на квартиру без учета ремонта
            function calculateDiscountWithoutRepair(contractPrice, repairCost) {
                const priceWithoutRepair = contractPrice - repairCost;
                
                if (priceWithoutRepair < kv.currentBasePrice) {
                    return Math.ceil(kv.currentBasePrice - priceWithoutRepair);
                }
                return 0;
            }
            
            // Функция сброса расчетов
            function resetKvCalculation() {
                kv.currentBasePrice = 0;
                kv.currentDiscountPrice = 0;
                kv.currentStatus = '';
                kv.currentFloor = '';
                kv.basePriceDisplay.textContent = formatMoney(0);
                
                kv.familyClientPV.textContent = formatMoney(0);
                kv.familyKV.textContent = formatMoney(0);
                kv.familyContractPrice.textContent = formatMoney(0);
                kv.familyLoanBody.textContent = formatMoney(0);
                kv.familyDiscount.textContent = "Нет скидки";
                kv.familyDiscount.className = "no-discount";
                kv.familyWarning.style.display = 'none';
                
                kv.standardClientPV.textContent = formatMoney(0);
                kv.standardKV.textContent = formatMoney(0);
                kv.standardContractPrice.textContent = formatMoney(0);
                kv.standardLoanBody.textContent = formatMoney(0);
                kv.standardDiscount.textContent = "Нет скидки";
                kv.standardDiscount.className = "no-discount";
                
                kv.calculationTime.style.display = 'none';
            }
            
            // Функция расчета для семейной ипотеки
            function calculateFamilyMortgage() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(kv.repairCostInput.value) || 0;
                const dduObjects = parseInt(kv.dduObjectsInput.value) || 0;
                const kvSubsidyPercent = parseFloat(kv.kvSubsidyInput.value) || 0;
                const clientPVPercent = parseFloat(kv.clientPVPercentInput.value) || 0;
                
                let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
                let iterations = 0;
                const maxIterations = 20;
                
                while (iterations < maxIterations) {
                    let clientPVRub = contractPrice * (clientPVPercent / 100);
                    
                    if (contractPrice - clientPVRub >= 6000000) {
                        kv.familyWarning.style.display = 'block';
                        kv.familyClientPV.textContent = "Увеличить ПВ клиента";
                        kv.familyKV.textContent = formatMoney(0);
                        kv.familyContractPrice.textContent = formatMoney(0);
                        kv.familyLoanBody.textContent = formatMoney(0);
                        kv.familyDiscount.textContent = "Нет скидки";
                        kv.familyDiscount.className = "no-discount";
                        return;
                    }
                    
                    let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                    newContractPrice = roundUpTo4Digits(newContractPrice);
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    
                    contractPrice = newContractPrice;
                    iterations++;
                }
                
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                let loanBody = contractPrice - clientPVRub;
                
                if (contractPrice - clientPVRub >= 6000000) {
                    kv.familyWarning.style.display = 'block';
                    kv.familyClientPV.textContent = "Увеличить ПВ клиента";
                    kv.familyKV.textContent = formatMoney(0);
                    kv.familyContractPrice.textContent = formatMoney(0);
                    kv.familyLoanBody.textContent = formatMoney(0);
                    kv.familyDiscount.textContent = "Нет скидки";
                    kv.familyDiscount.className = "no-discount";
                    return;
                }
                
                const discountWithoutRepair = calculateDiscountWithoutRepair(contractPrice, repairCost);
                
                kv.familyClientPV.textContent = formatMoney(clientPVRub);
                kv.familyKV.textContent = formatMoney(kvRub);
                kv.familyContractPrice.textContent = formatMoney(contractPrice);
                kv.familyLoanBody.textContent = formatMoney(loanBody);
                
                if (discountWithoutRepair > 0) {
                    kv.familyDiscount.textContent = formatMoney(discountWithoutRepair);
                    kv.familyDiscount.className = "discount";
                } else {
                    kv.familyDiscount.textContent = "Нет скидки";
                    kv.familyDiscount.className = "no-discount";
                }
                
                kv.familyWarning.style.display = 'none';
            }
            
            // Функция расчета для стандартной ипотеки
            function calculateStandardMortgage() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(kv.repairCostInput.value) || 0;
                const dduObjects = parseInt(kv.dduObjectsInput.value) || 0;
                const kvSubsidyPercent = parseFloat(kv.kvSubsidyInput.value) || 0;
                const clientPVPercent = parseFloat(kv.clientPVPercentInput.value) || 0;
                
                let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
                let iterations = 0;
                const maxIterations = 20;
                
                while (iterations < maxIterations) {
                    let clientPVRub = contractPrice * (clientPVPercent / 100);
                    let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                    newContractPrice = roundUpTo4Digits(newContractPrice);
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    
                    contractPrice = newContractPrice;
                    iterations++;
                }
                
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                let loanBody = contractPrice - clientPVRub;
                const discountWithoutRepair = calculateDiscountWithoutRepair(contractPrice, repairCost);
                
                kv.standardClientPV.textContent = formatMoney(clientPVRub);
                kv.standardKV.textContent = formatMoney(kvRub);
                kv.standardContractPrice.textContent = formatMoney(contractPrice);
                kv.standardLoanBody.textContent = formatMoney(loanBody);
                
                if (discountWithoutRepair > 0) {
                    kv.standardDiscount.textContent = formatMoney(discountWithoutRepair);
                    kv.standardDiscount.className = "discount";
                } else {
                    kv.standardDiscount.textContent = "Нет скидки";
                    kv.standardDiscount.className = "no-discount";
                }
            }
            
            // Функция расчета
            function calculateKv() {
                if (kv.currentStatus === "Продано") {
                    return;
                }
                
                calculateFamilyMortgage();
                calculateStandardMortgage();
                
                // Обновляем время расчета
                updateCalculationTime('kv-timeValue');
            }

            // Заполнение списка ЖК для КВ
            function populateKvComplexes() {
                const complexes = [...new Set(allApartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
                kv.complexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
                complexes.forEach(complex => {
                    const option = document.createElement('option');
                    option.value = complex;
                    option.textContent = complex;
                    kv.complexSelect.appendChild(option);
                });
            }

            // События для КВ
            kv.complexSelect.addEventListener('change', function() {
                const complex = this.value;
                kv.sectionSelect.disabled = !complex;
                kv.apartmentSelect.disabled = true;
                kv.apartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                kv.selectedApartmentInfo.style.display = 'none';
                kv.soldNotice.style.display = 'none';
                kv.apartmentFullDetails.style.display = 'none';
                resetKvCalculation();

                if (complex) {
                    // Фильтруем данные по выбранному ЖК
                    const apartmentsData = allApartmentsData.filter(item => item["Название ЖК"] === complex);
                    
                    const sections = [...new Set(apartmentsData
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    kv.sectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        kv.sectionSelect.appendChild(option);
                    });
                    
                    kv.sectionSelect.disabled = false;
                }
            });

            kv.sectionSelect.addEventListener('change', function() {
                const complex = kv.complexSelect.value;
                const section = this.value;
                kv.apartmentSelect.disabled = !section;
                kv.selectedApartmentInfo.style.display = 'none';
                kv.soldNotice.style.display = 'none';
                kv.apartmentFullDetails.style.display = 'none';
                resetKvCalculation();

                if (complex && section) {
                    // Фильтруем данные по выбранному ЖК и дому
                    const apartments = allApartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            floor: item["Этаж"] || '',
                            planUrl: item["3D тур квартиры"]
                        }));

                    kv.apartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.floor = apartment.floor || '';
                        option.dataset.planUrl = apartment.planUrl || '';
                        kv.apartmentSelect.appendChild(option);
                    });
                    
                    kv.apartmentSelect.disabled = false;
                }
            });

            kv.apartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                kv.selectedApartmentInfo.style.display = 'none';
                kv.soldNotice.style.display = 'none';
                kv.apartmentFullDetails.style.display = 'none';
                resetKvCalculation();

                if (selectedOption.value) {
                    kv.currentBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    kv.currentDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    kv.currentStatus = selectedOption.dataset.status || '';
                    kv.currentComplex = selectedOption.dataset.complex;
                    kv.currentSection = selectedOption.dataset.section;
                    kv.currentApartmentNumber = selectedOption.value;
                    kv.currentRoomType = selectedOption.dataset.roomType;
                    kv.currentArea = selectedOption.dataset.area;
                    kv.currentFloor = selectedOption.dataset.floor || '';
                    kv.currentPlanUrl = selectedOption.dataset.planUrl;

                    if (kv.currentStatus === "Продано") {
                        kv.soldNotice.style.display = 'block';
                        return;
                    }

                    kv.apartmentDetails.innerHTML = `
                        <div>ЖК: ${kv.currentComplex}</div>
                        <div>Дом: ${kv.currentSection}</div>
                        <div>Квартира: ${kv.currentApartmentNumber}</div>
                    `;
                    kv.selectedApartmentInfo.style.display = 'block';

                    kv.apartmentComplex.textContent = `Жилой комплекс: ${kv.currentComplex}`;
                    kv.apartmentSection.textContent = `Дом: ${kv.currentSection}`;
                    kv.apartmentNumber.textContent = `Квартира: ${kv.currentApartmentNumber}`;
                    kv.apartmentRooms.textContent = `Комнатность: ${getRoomTypeText(parseInt(kv.currentRoomType))}`;
                    kv.apartmentArea.textContent = `Площадь: ${kv.currentArea} м²`;
                    kv.apartmentFloor.textContent = `Этаж: ${kv.currentFloor}`;
                    
                    if (kv.currentPlanUrl && kv.currentPlanUrl.trim() !== '') {
                        kv.apartmentPlan.innerHTML = `<a href="${kv.currentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
                    } else {
                        kv.apartmentPlan.innerHTML = '';
                    }
                    
                    kv.apartmentFullDetails.style.display = 'block';

                    kv.basePriceDisplay.textContent = formatMoney(kv.currentBasePrice);
                    
                    calculateKv();
                }
            });

            // Слушатели событий для КВ
            kv.managerDiscountCheckbox.addEventListener('change', calculateKv);
            kv.repairCostInput.addEventListener('input', calculateKv);
            kv.dduObjectsInput.addEventListener('input', calculateKv);
            kv.kvSubsidyInput.addEventListener('input', calculateKv);
            kv.clientPVPercentInput.addEventListener('input', calculateKv);

            // Инициализация КВ
            populateKvComplexes();
            setupKvOptionsCollapsible();
        }

        // Запуск загрузки данных при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadAllApartmentsData);
    </script>
</body>
</html>
