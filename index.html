<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Набор калькуляторов - ПАРИТЕТ ДЕВЕЛОПМЕНТ</title>
    <style>
        /* Основные цвета бренда */
        :root {
            --white: #FFFFFF;
            --red: #F50024;
            --black: #000000;
            --light-gray: #f5f5f5;
            --dark-gray: #333333;
            --border-color: #e0e0e0;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--white);
            color: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--red);
            width: 100%;
        }
        
        h1 {
            color: var(--black);
            margin-top: 20px;
        }
        
        .calculator-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .calc-button {
            background-color: var(--white);
            color: var(--black);
            border: 2px solid var(--red);
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .calc-button:hover {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calc-button.active {
            background-color: var(--red);
            color: var(--white);
        }
        
        .calculator-container {
            display: flex;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            justify-content: center;
        }
        
        .calculator-form {
            flex: 0 0 45%;
            background: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .calculator-results {
            flex: 0 0 45%;
            background: var(--light-gray);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--red);
        }
        
        .calculator-section {
            display: none;
            width: 100%;
            justify-content: center;
        }
        
        .calculator-section.active {
            display: flex;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--black);
        }
        
        select, input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .highlight {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--red);
        }
        
        .price-comparison {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 15px;
            background: var(--light-gray);
            border-radius: 5px;
        }
        
        .discount {
            color: var(--red);
            font-weight: bold;
        }
        
        .no-discount {
            color: var(--dark-gray);
            font-weight: bold;
        }
        
        .warning {
            color: var(--red);
            font-weight: bold;
        }
        
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        
        .apartment-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .sold-notice {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .mortgage-block {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .mortgage-block h3 {
            margin-top: 0;
            color: var(--black);
            border-bottom: 2px solid var(--red);
            padding-bottom: 10px;
        }
        
        .payment-warning {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .apartment-details {
            margin-top: 20px;
            padding: 15px;
            background: var(--light-gray);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .apartment-details h3 {
            margin-top: 0;
            color: var(--black);
        }
        
        .apartment-details div {
            margin-bottom: 5px;
        }
        
        h2 {
            margin-top: 0;
            color: var(--black);
        }
        
        .plan-button {
            background-color: var(--red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
        }
        
        .plan-button:hover {
            background-color: #d4001f;
        }
        
        .plan-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .additional-costs {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .manager-discount {
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .bank-discount {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .input-with-slider {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .manual-input {
            width: 150px;
        }
        
        .term-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 5px;
        }
        
        .min-payment-info {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin-top: 5px;
        }
        
        .complex-display {
            padding: 8px;
            background: #f8d7da;
            border-radius: 4px;
            border: 1px solid var(--red);
            font-weight: bold;
            color: #721c24;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #d1d1d1;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .calculator-container {
                flex-direction: column;
            }
            
            .calculator-buttons {
                flex-direction: column;
            }
            
            .calculator-form, .calculator-results {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Набор калькуляторов</h1>
        <div class="calculator-buttons">
            <button class="calc-button active" data-calc="chpv-300-3">Калькулятор ЧПВ 300 000 + 3%</button>
            <button class="calc-button" data-calc="kv">Расчет КВ</button>
        </div>
    </div>

    <!-- Калькулятор ЧПВ 300 000 + 3% -->
    <div id="chpv-300-3-calculator" class="calculator-section active">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор ЧПВ 300 000 + 3%</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="chpv-300-3-complexSelect">Жилой комплекс:</label>
                    <select id="chpv-300-3-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv-300-3-sectionSelect">Название дома:</label>
                    <select id="chpv-300-3-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="chpv-300-3-apartmentSelect">Квартира:</label>
                    <select id="chpv-300-3-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="chpv-300-3-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="chpv-300-3-apartmentDetails"></div>
                </div>

                <div id="chpv-300-3-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <!-- Убрана цена со скидкой из отображения -->
                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="chpv-300-3-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <div class="manager-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="chpv-300-3-managerDiscount">
                        <label for="chpv-300-3-managerDiscount">Скидка менеджера</label>
                    </div>
                    <div style="font-size: 0.9em; color: var(--dark-gray);">
                        При включенной скидке менеджера цена уменьшается на 100,000 ₽
                    </div>
                </div>
                
                <div class="bank-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="chpv-300-3-bankDiscount">
                        <label for="chpv-300-3-bankDiscount">для Альфа Банка</label>
                    </div>
                    <div style="font-size: 0.9em; color: #17a2b8;">
                        При включении добавляется комиссия банка 9,5% от тела кредита
                    </div>
                </div>
                
                <!-- Дополнительные расходы -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="chpv-300-3-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="chpv-300-3-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="chpv-300-3-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="chpv-300-3-dduObjects" value="0" min="0" step="10000">
                    </div>
                </div>
                
                <!-- Первоначальный взнос клиента -->
                <div class="form-group">
                    <label for="chpv-300-3-clientDownPayment">Первоначальный взнос клиента (₽):</label>
                    <input type="number" id="chpv-300-3-clientDownPayment" value="0" min="0" step="10000">
                    <div id="chpv-300-3-minPaymentInfo" class="min-payment-info"></div>
                </div>
                
                <div id="chpv-300-3-paymentWarning" class="payment-warning" style="display: none;">
                    Первоначальный взнос клиента меньше минимального требуемого!
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                <div class="result-item">
                    <span>Стоимость договора для ДДУ:</span>
                    <span id="chpv-300-3-resultContractPrice" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Общий ПВ:</span>
                    <span id="chpv-300-3-resultTotalPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Паритет ПВ:</span>
                    <span id="chpv-300-3-resultCompanyPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Клиента ПВ:</span>
                    <span id="chpv-300-3-resultClientPV" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Тело кредита:</span>
                    <span id="chpv-300-3-resultLoanBody" class="highlight">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Процент ПВ:</span>
                    <span id="chpv-300-3-resultPVPercent" class="highlight">0%</span>
                </div>
                <div id="chpv-300-3-bankCommissionItem" class="result-item" style="display: none;">
                    <span>Комиссия банка (9,5%):</span>
                    <span id="chpv-300-3-resultBankCommission" class="info">0 ₽</span>
                </div>
                <div class="result-item">
                    <span>Скидка на квартиру без учета ремонта:</span>
                    <span id="chpv-300-3-resultDiscountWithoutRepair" class="no-discount">Нет скидки</span>
                </div>
                
                <div id="chpv-300-3-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="chpv-300-3-apartmentComplex"></div>
                    <div id="chpv-300-3-apartmentSection"></div>
                    <div id="chpv-300-3-apartmentNumber"></div>
                    <div id="chpv-300-3-apartmentRooms"></div>
                    <div id="chpv-300-3-apartmentArea"></div>
                    <div id="chpv-300-3-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Калькулятор КВ -->
    <div id="kv-calculator" class="calculator-section">
        <div class="calculator-container">
            <div class="calculator-form">
                <h2>Калькулятор КВ</h2>

                <!-- Выбор квартиры -->
                <div class="form-group">
                    <label for="kv-complexSelect">Жилой комплекс:</label>
                    <select id="kv-complexSelect">
                        <option value="">Загрузка...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-sectionSelect">Название дома:</label>
                    <select id="kv-sectionSelect" disabled>
                        <option value="">Сначала выберите ЖК</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kv-apartmentSelect">Квартира:</label>
                    <select id="kv-apartmentSelect" disabled>
                        <option value="">Сначала выберите дом</option>
                    </select>
                </div>

                <div id="kv-selectedApartmentInfo" class="apartment-info" style="display: none;">
                    <strong>Выбранная квартира:</strong>
                    <div id="kv-apartmentDetails"></div>
                </div>

                <div id="kv-soldNotice" class="sold-notice" style="display: none;">
                    Эта квартира уже продана
                </div>

                <!-- Убрана цена со скидкой из отображения -->
                <div class="price-comparison">
                    <div>
                        <strong>Цена квартиры:</strong><br>
                        <span id="kv-basePriceDisplay">0 ₽</span>
                    </div>
                </div>
                
                <!-- Чекбокс скидки менеджера -->
                <div class="manager-discount">
                    <div class="checkbox-group">
                        <input type="checkbox" id="kv-managerDiscount">
                        <label for="kv-managerDiscount">Скидка менеджера</label>
                    </div>
                    <div style="font-size: 0.9em; color: var(--dark-gray);">
                        При включенной скидке менеджера цена уменьшается на 100,000 ₽
                    </div>
                </div>
                
                <!-- Новые поля для ввода -->
                <div class="additional-costs">
                    <div class="form-group">
                        <label for="kv-repairCost">Цена ремонта (₽):</label>
                        <input type="number" id="kv-repairCost" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-kvSubsidy">Субсидия КВ в %:</label>
                        <input type="number" id="kv-kvSubsidy" value="4.5" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-dduObjects">Объекты, зашитые в ДДУ (₽):</label>
                        <input type="number" id="kv-dduObjects" value="0" min="0" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label for="kv-clientPVPercent">ПВ клиента (%):</label>
                        <input type="number" id="kv-clientPVPercent" value="20.1" min="0" step="0.1">
                    </div>
                </div>
            </div>
            
            <div class="calculator-results">
                <h2>Результаты расчета:</h2>
                
                <!-- Блок для семейной ипотеки -->
                <div class="mortgage-block">
                    <h3>Семейная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-familyClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>КВ рублей:</span>
                        <span id="kv-familyKV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-familyContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-familyLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-familyDiscount" class="no-discount">Нет скидки</span>
                    </div>
                    <div id="kv-familyWarning" class="payment-warning" style="display: none;">
                        Увеличить ПВ клиента
                    </div>
                </div>
                
                <!-- Блок для стандартной ипотеки -->
                <div class="mortgage-block">
                    <h3>Стандартная ипотека</h3>
                    <div class="result-item">
                        <span>ПВ клиента рублей:</span>
                        <span id="kv-standardClientPV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>КВ рублей:</span>
                        <span id="kv-standardKV" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Стоимость договора для ДДУ:</span>
                        <span id="kv-standardContractPrice" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Тело кредита:</span>
                        <span id="kv-standardLoanBody" class="highlight">0 ₽</span>
                    </div>
                    <div class="result-item">
                        <span>Скидка на квартиру без учета ремонта:</span>
                        <span id="kv-standardDiscount" class="no-discount">Нет скидки</span>
                    </div>
                </div>
                
                <div id="kv-apartmentFullDetails" class="apartment-details" style="display: none;">
                    <h3>Информация о квартире:</h3>
                    <div id="kv-apartmentComplex"></div>
                    <div id="kv-apartmentSection"></div>
                    <div id="kv-apartmentNumber"></div>
                    <div id="kv-apartmentRooms"></div>
                    <div id="kv-apartmentArea"></div>
                    <div id="kv-apartmentPlan"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Общие функции
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ₽';
        }

        function getRoomTypeText(roomType) {
            const roomTypes = {
                0: 'Студия',
                1: '1-комнатная',
                2: '2-комнатная',
                3: '3-комнатная'
            };
            return roomTypes[roomType] || 'Неизвестно';
        }

        // Переключение между калькуляторами
        const calculatorButtons = document.querySelectorAll('.calc-button');
        const calculatorSections = document.querySelectorAll('.calculator-section');

        calculatorButtons.forEach(button => {
            button.addEventListener('click', () => {
                const calculatorId = button.getAttribute('data-calc');
                
                // Убираем активный класс у всех кнопок
                calculatorButtons.forEach(btn => btn.classList.remove('active'));
                // Добавляем активный класс текущей кнопке
                button.classList.add('active');
                
                // Скрываем все калькуляторы
                calculatorSections.forEach(section => section.classList.remove('active'));
                // Показываем выбранный калькулятор
                document.getElementById(`${calculatorId}-calculator`).classList.add('active');
                
                // Загружаем данные для активного калькулятора
                if (calculatorId === 'chpv-300-3') {
                    initCHPV3003Calculator();
                } else if (calculatorId === 'kv') {
                    initKVCalculator();
                }
            });
        });

        // ==================== КАЛЬКУЛЯТОР ЧПВ 300 000 + 3% ====================
        let apartmentsData = [];
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVMdD1qLq8N3hBj1OV-xVXz5T9wwOcDTPSa09j5Ty7kxm7YY1SErU5fXkoqWxO2zZ2/exec';

        // Для ЧПВ 300 000 + 3%
        let chpv3003Initialized = false;
        
        function initCHPV3003Calculator() {
            if (chpv3003Initialized) return;
            
            // Элементы DOM
            const complexSelect = document.getElementById('chpv-300-3-complexSelect');
            const sectionSelect = document.getElementById('chpv-300-3-sectionSelect');
            const apartmentSelect = document.getElementById('chpv-300-3-apartmentSelect');
            const selectedApartmentInfo = document.getElementById('chpv-300-3-selectedApartmentInfo');
            const apartmentDetails = document.getElementById('chpv-300-3-apartmentDetails');
            const soldNotice = document.getElementById('chpv-300-3-soldNotice');
            const basePriceDisplay = document.getElementById('chpv-300-3-basePriceDisplay');
            const managerDiscountCheckbox = document.getElementById('chpv-300-3-managerDiscount');
            const bankDiscountCheckbox = document.getElementById('chpv-300-3-bankDiscount');
            const repairCostInput = document.getElementById('chpv-300-3-repairCost');
            const dduObjectsInput = document.getElementById('chpv-300-3-dduObjects');
            const clientDownPaymentInput = document.getElementById('chpv-300-3-clientDownPayment');
            const minPaymentInfo = document.getElementById('chpv-300-3-minPaymentInfo');
            const paymentWarning = document.getElementById('chpv-300-3-paymentWarning');
            const apartmentFullDetails = document.getElementById('chpv-300-3-apartmentFullDetails');
            
            // Результаты
            const resultContractPrice = document.getElementById('chpv-300-3-resultContractPrice');
            const resultTotalPV = document.getElementById('chpv-300-3-resultTotalPV');
            const resultCompanyPV = document.getElementById('chpv-300-3-resultCompanyPV');
            const resultClientPV = document.getElementById('chpv-300-3-resultClientPV');
            const resultLoanBody = document.getElementById('chpv-300-3-resultLoanBody');
            const resultPVPercent = document.getElementById('chpv-300-3-resultPVPercent');
            const bankCommissionItem = document.getElementById('chpv-300-3-bankCommissionItem');
            const resultBankCommission = document.getElementById('chpv-300-3-resultBankCommission');
            const resultDiscountWithoutRepair = document.getElementById('chpv-300-3-resultDiscountWithoutRepair');
            
            // Информация о квартире
            const apartmentComplex = document.getElementById('chpv-300-3-apartmentComplex');
            const apartmentSection = document.getElementById('chpv-300-3-apartmentSection');
            const apartmentNumber = document.getElementById('chpv-300-3-apartmentNumber');
            const apartmentRooms = document.getElementById('chpv-300-3-apartmentRooms');
            const apartmentArea = document.getElementById('chpv-300-3-apartmentArea');
            const apartmentPlan = document.getElementById('chpv-300-3-apartmentPlan');

            // Текущие цены выбранной квартиры
            let currentBasePrice = 0;
            let currentOriginalBasePrice = 0;
            let currentDiscountPrice = 0;
            let currentOriginalDiscountPrice = 0;
            let currentStatus = '';
            let currentComplex = '';
            let currentSection = '';
            let currentApartmentNumber = '';
            let currentRoomType = '';
            let currentArea = '';
            let currentPlanUrl = '';

            // ЖК с увеличенной ценой на 3%
            const increasedPriceComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
            const PRICE_INCREASE_RATE = 0.03;

            // Коэффициенты для расчета минимального ПВ
            const coefficients = {
                'АСТРО': [
                    { max: 5000000, value: 0.10 },
                    { max: 8000000, value: 0.12 },
                    { max: 12000000, value: 0.15 }
                ],
                'ЧИСТЫЕ ПРУДЫ': [
                    { max: 5000000, value: 0.095 },
                    { max: 8000000, value: 0.105 },
                    { max: 14000000, value: 0.135 }
                ],
                'Счастье': [
                    { max: 2000000, value: 0.065 },
                    { max: 3500000, value: 0.09 },
                    { max: 6500000, value: 0.11 }
                ],
                'Тёплые кварталы': [
                    { max: 5000000, value: 0.105 },
                    { max: 8000000, value: 0.125 },
                    { max: 14000000, value: 0.145 }
                ],
                'Бодровский': [
                    { max: 5000000, value: 0.10 },
                    { max: 8000000, value: 0.12 },
                    { max: 14000000, value: 0.14 }
                ],
                'Комсомольский': [
                    { max: 5000000, value: 0.10 },
                    { max: 8000000, value: 0.12 },
                    { max: 14000000, value: 0.14 }
                ]
            };

            // ЖК с фиксированным минимальным ПВ 300 000 ₽
            const fixedMinPaymentComplexes = ['Бодровский', 'Комсомольский', 'ЧИСТЫЕ ПРУДЫ'];
            const FIXED_MIN_PAYMENT = 300000;

            // Комиссия банка
            const BANK_COMMISSION_RATE = 0.095;

            // Функция для получения коэффициента для ЖК
            function getCoefficient(complex, basePrice) {
                const complexCoeffs = coefficients[complex];
                if (!complexCoeffs) return 0.10;
                
                for (let i = 0; i < complexCoeffs.length; i++) {
                    if (basePrice <= complexCoeffs[i].max) {
                        return complexCoeffs[i].value;
                    }
                }
                
                return complexCoeffs[complexCoeffs.length - 1].value;
            }

            // Функция проверки, является ли ЖК с фиксированным минимальным ПВ
            function isFixedMinPaymentComplex(complex) {
                return fixedMinPaymentComplexes.includes(complex);
            }

            // Функция проверки, нужно ли увеличивать цену для ЖК
            function isPriceIncreasedComplex(complex) {
                return increasedPriceComplexes.includes(complex);
            }

            // Функция расчета минимального ПВ клиента
            function calculateMinClientPayment() {
                if (isFixedMinPaymentComplex(currentComplex)) {
                    return FIXED_MIN_PAYMENT;
                }
                
                const repairCost = parseInt(repairCostInput.value) || 0;
                const dduObjects = parseInt(dduObjectsInput.value) || 0;
                const totalBase = currentBasePrice + repairCost + dduObjects;
                const coefficient = getCoefficient(currentComplex, currentBasePrice);
                
                return Math.round(totalBase * coefficient);
            }

            // Заполнение списка ЖК
            function populateComplexes() {
                const complexes = [...new Set(apartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
                complexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
                complexes.forEach(complex => {
                    const option = document.createElement('option');
                    option.value = complex;
                    option.textContent = complex;
                    complexSelect.appendChild(option);
                });
            }

            // При изменении ЖК
            complexSelect.addEventListener('change', function() {
                const complex = this.value;
                sectionSelect.disabled = !complex;
                apartmentSelect.disabled = true;
                apartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                selectedApartmentInfo.style.display = 'none';
                soldNotice.style.display = 'none';
                apartmentFullDetails.style.display = 'none';
                resetCalculation();

                if (complex) {
                    const sections = [...new Set(apartmentsData
                        .filter(item => item["Название ЖК"] === complex)
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    sectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        sectionSelect.appendChild(option);
                    });
                }
            });

            // При изменении дома
            sectionSelect.addEventListener('change', function() {
                const complex = complexSelect.value;
                const section = this.value;
                apartmentSelect.disabled = !section;
                selectedApartmentInfo.style.display = 'none';
                soldNotice.style.display = 'none';
                apartmentFullDetails.style.display = 'none';
                resetCalculation();

                if (complex && section) {
                    const apartments = apartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            planUrl: item["3D тур квартиры"]
                        }));

                    apartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.planUrl = apartment.planUrl || '';
                        apartmentSelect.appendChild(option);
                    });
                }
            });

            // При изменении квартиры
            apartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                selectedApartmentInfo.style.display = 'none';
                soldNotice.style.display = 'none';
                apartmentFullDetails.style.display = 'none';
                resetCalculation();

                if (selectedOption.value) {
                    currentOriginalBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    currentOriginalDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    
                    currentStatus = selectedOption.dataset.status || '';
                    currentComplex = selectedOption.dataset.complex;
                    currentSection = selectedOption.dataset.section;
                    currentApartmentNumber = selectedOption.value;
                    currentRoomType = selectedOption.dataset.roomType;
                    currentArea = selectedOption.dataset.area;
                    currentPlanUrl = selectedOption.dataset.planUrl;

                    if (isPriceIncreasedComplex(currentComplex)) {
                        currentBasePrice = Math.round(currentOriginalBasePrice * (1 + PRICE_INCREASE_RATE));
                        currentDiscountPrice = Math.round(currentOriginalDiscountPrice * (1 + PRICE_INCREASE_RATE));
                    } else {
                        currentBasePrice = currentOriginalBasePrice;
                        currentDiscountPrice = currentOriginalDiscountPrice;
                    }

                    if (currentStatus === "Продано") {
                        soldNotice.style.display = 'block';
                        return;
                    }

                    apartmentDetails.innerHTML = `
                        <div>ЖК: ${currentComplex}</div>
                        <div>Дом: ${currentSection}</div>
                        <div>Квартира: ${currentApartmentNumber}</div>
                    `;
                    selectedApartmentInfo.style.display = 'block';

                    updateApartmentFullDetails();
                    updatePriceDisplay();
                    
                    calculate();
                }
            });

            // Функция обновления полной информации о квартире
            function updateApartmentFullDetails() {
                apartmentComplex.textContent = `Жилой комплекс: ${currentComplex}`;
                apartmentSection.textContent = `Дом: ${currentSection}`;
                apartmentNumber.textContent = `Квартира: ${currentApartmentNumber}`;
                apartmentRooms.textContent = `Комнатность: ${getRoomTypeText(parseInt(currentRoomType))}`;
                apartmentArea.textContent = `Площадь: ${currentArea} м²`;
                
                if (currentPlanUrl && currentPlanUrl.trim() !== '') {
                    apartmentPlan.innerHTML = `<a href="${currentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
                } else {
                    apartmentPlan.innerHTML = '';
                }
                
                apartmentFullDetails.style.display = 'block';
            }

            // Функция обновления отображения цен
            function updatePriceDisplay() {
                basePriceDisplay.textContent = formatMoney(currentBasePrice);
            }

            // Функция получения скорректированной цены со скидкой
            function getAdjustedDiscountPrice() {
                return managerDiscountCheckbox.checked ? 
                    currentDiscountPrice : 
                    currentDiscountPrice + 100000;
            }

            // Функция расчета стоимости договора для ДДУ
            function calculateContractPrice() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(repairCostInput.value) || 0;
                const dduObjects = parseInt(dduObjectsInput.value) || 0;
                const clientPV = parseInt(clientDownPaymentInput.value) || 0;
                const forBank = bankDiscountCheckbox.checked;
                
                let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
                let bankCommission = 0;
                
                for (let i = 0; i < 10; i++) {
                    let totalPV = Math.ceil(contractPrice * 0.201);
                    let companyPV = totalPV - clientPV;
                    let loanBody = contractPrice - totalPV;
                    
                    if (forBank) {
                        bankCommission = Math.round(loanBody * BANK_COMMISSION_RATE);
                    } else {
                        bankCommission = 0;
                    }
                    
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + companyPV + companyPV * 0.05;
                    
                    if (forBank) {
                        newContractPrice += bankCommission;
                    }
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    contractPrice = newContractPrice;
                }
                
                return {
                    contractPrice: Math.round(contractPrice),
                    bankCommission: bankCommission
                };
            }
            
            // Функция расчета скидки на квартиру без учета ремонта
            function calculateDiscountWithoutRepair(contractPrice) {
                const repairCost = parseInt(repairCostInput.value) || 0;
                const priceWithoutRepair = contractPrice - repairCost;
                
                if (priceWithoutRepair < currentBasePrice) {
                    return Math.ceil(currentBasePrice - priceWithoutRepair);
                }
                return 0;
            }
            
            // Функция сброса расчетов
            function resetCalculation() {
                currentBasePrice = 0;
                currentOriginalBasePrice = 0;
                currentDiscountPrice = 0;
                currentOriginalDiscountPrice = 0;
                currentStatus = '';
                updatePriceDisplay();
                
                resultContractPrice.textContent = formatMoney(0);
                resultTotalPV.textContent = formatMoney(0);
                resultCompanyPV.textContent = formatMoney(0);
                resultClientPV.textContent = formatMoney(0);
                resultLoanBody.textContent = formatMoney(0);
                resultPVPercent.textContent = "0%";
                resultBankCommission.textContent = formatMoney(0);
                bankCommissionItem.style.display = 'none';
                resultDiscountWithoutRepair.textContent = "Нет скидки";
                resultDiscountWithoutRepair.className = "no-discount";
                
                minPaymentInfo.textContent = '';
                paymentWarning.style.display = 'none';
            }
            
            // Функция расчета
            function calculate() {
                if (currentStatus === "Продано") {
                    return;
                }
                
                const clientPV = parseInt(clientDownPaymentInput.value) || 0;
                const forBank = bankDiscountCheckbox.checked;
                
                const minClientPayment = calculateMinClientPayment();
                
                if (isFixedMinPaymentComplex(currentComplex)) {
                    minPaymentInfo.textContent = `Минимальный первоначальный взнос: ${formatMoney(FIXED_MIN_PAYMENT)}`;
                } else {
                    const coefficient = getCoefficient(currentComplex, currentBasePrice);
                    minPaymentInfo.textContent = `Минимальный первоначальный взнос: ${formatMoney(minClientPayment)}`;
                }
                
                if (clientPV < minClientPayment) {
                    paymentWarning.style.display = 'block';
                    const amountToAdd = minClientPayment - clientPV;
                    paymentWarning.textContent = `Первоначальный взнос клиента меньше минимального требуемого! Необходимо добавить еще ${formatMoney(amountToAdd)}`;
                    
                    resultContractPrice.textContent = formatMoney(0);
                    resultTotalPV.textContent = formatMoney(0);
                    resultCompanyPV.textContent = formatMoney(0);
                    resultClientPV.textContent = formatMoney(clientPV);
                    resultLoanBody.textContent = formatMoney(0);
                    resultPVPercent.textContent = "0%";
                    resultBankCommission.textContent = formatMoney(0);
                    bankCommissionItem.style.display = 'none';
                    resultDiscountWithoutRepair.textContent = "Нет скидки";
                    resultDiscountWithoutRepair.className = "no-discount";
                    return;
                } else {
                    paymentWarning.style.display = 'none';
                }
                
                const calculationResult = calculateContractPrice();
                const contractPrice = calculationResult.contractPrice;
                const bankCommission = calculationResult.bankCommission;
                
                const totalPV = Math.ceil(contractPrice * 0.201);
                const companyPV = totalPV - clientPV;
                const loanBody = contractPrice - totalPV;
                const pvPercent = (totalPV / contractPrice * 100).toFixed(6);
                const discountWithoutRepair = calculateDiscountWithoutRepair(contractPrice);
                
                resultContractPrice.textContent = formatMoney(contractPrice);
                resultTotalPV.textContent = formatMoney(totalPV);
                resultCompanyPV.textContent = formatMoney(companyPV);
                resultClientPV.textContent = formatMoney(clientPV);
                resultLoanBody.textContent = formatMoney(loanBody);
                resultPVPercent.textContent = `${pvPercent}%`;
                
                if (forBank) {
                    resultBankCommission.textContent = formatMoney(bankCommission);
                    bankCommissionItem.style.display = 'flex';
                } else {
                    bankCommissionItem.style.display = 'none';
                }
                
                if (discountWithoutRepair > 0) {
                    resultDiscountWithoutRepair.textContent = formatMoney(discountWithoutRepair);
                    resultDiscountWithoutRepair.className = "discount";
                } else {
                    resultDiscountWithoutRepair.textContent = "Нет скидки";
                    resultDiscountWithoutRepair.className = "no-discount";
                }
            }
            
            // Слушатели событий
            managerDiscountCheckbox.addEventListener('change', function() {
                updatePriceDisplay();
                calculate();
            });
            
            bankDiscountCheckbox.addEventListener('change', function() {
                calculate();
            });
            
            repairCostInput.addEventListener('input', calculate);
            dduObjectsInput.addEventListener('input', calculate);
            clientDownPaymentInput.addEventListener('input', calculate);
            
            // Инициализация
            populateComplexes();
            chpv3003Initialized = true;
        }

        // ==================== КАЛЬКУЛЯТОР КВ ====================
        let kvInitialized = false;
        
        function initKVCalculator() {
            if (kvInitialized) return;
            
            // Элементы DOM
            const complexSelect = document.getElementById('kv-complexSelect');
            const sectionSelect = document.getElementById('kv-sectionSelect');
            const apartmentSelect = document.getElementById('kv-apartmentSelect');
            const selectedApartmentInfo = document.getElementById('kv-selectedApartmentInfo');
            const apartmentDetails = document.getElementById('kv-apartmentDetails');
            const soldNotice = document.getElementById('kv-soldNotice');
            const basePriceDisplay = document.getElementById('kv-basePriceDisplay');
            const managerDiscountCheckbox = document.getElementById('kv-managerDiscount');
            const repairCostInput = document.getElementById('kv-repairCost');
            const dduObjectsInput = document.getElementById('kv-dduObjects');
            const kvSubsidyInput = document.getElementById('kv-kvSubsidy');
            const clientPVPercentInput = document.getElementById('kv-clientPVPercent');
            const apartmentFullDetails = document.getElementById('kv-apartmentFullDetails');
            
            // Результаты для семейной ипотеки
            const familyClientPV = document.getElementById('kv-familyClientPV');
            const familyKV = document.getElementById('kv-familyKV');
            const familyContractPrice = document.getElementById('kv-familyContractPrice');
            const familyLoanBody = document.getElementById('kv-familyLoanBody');
            const familyDiscount = document.getElementById('kv-familyDiscount');
            const familyWarning = document.getElementById('kv-familyWarning');
            
            // Результаты для стандартной ипотеки
            const standardClientPV = document.getElementById('kv-standardClientPV');
            const standardKV = document.getElementById('kv-standardKV');
            const standardContractPrice = document.getElementById('kv-standardContractPrice');
            const standardLoanBody = document.getElementById('kv-standardLoanBody');
            const standardDiscount = document.getElementById('kv-standardDiscount');
            
            // Информация о квартире
            const apartmentComplex = document.getElementById('kv-apartmentComplex');
            const apartmentSection = document.getElementById('kv-apartmentSection');
            const apartmentNumber = document.getElementById('kv-apartmentNumber');
            const apartmentRooms = document.getElementById('kv-apartmentRooms');
            const apartmentArea = document.getElementById('kv-apartmentArea');
            const apartmentPlan = document.getElementById('kv-apartmentPlan');

            // Текущие цены выбранной квартиры
            let currentBasePrice = 0;
            let currentDiscountPrice = 0;
            let currentStatus = '';
            let currentComplex = '';
            let currentSection = '';
            let currentApartmentNumber = '';
            let currentRoomType = '';
            let currentArea = '';
            let currentPlanUrl = '';

            // Функция получения скорректированной цены со скидкой
            function getAdjustedDiscountPrice() {
                return managerDiscountCheckbox.checked ? 
                    currentDiscountPrice : 
                    currentDiscountPrice + 100000;
            }

            // Заполнение списка ЖК
            function populateComplexes() {
                const complexes = [...new Set(apartmentsData.map(item => item["Название ЖК"]).filter(Boolean))];
                complexSelect.innerHTML = '<option value="">Выберите ЖК</option>';
                complexes.forEach(complex => {
                    const option = document.createElement('option');
                    option.value = complex;
                    option.textContent = complex;
                    complexSelect.appendChild(option);
                });
            }

            // При изменении ЖК
            complexSelect.addEventListener('change', function() {
                const complex = this.value;
                sectionSelect.disabled = !complex;
                apartmentSelect.disabled = true;
                apartmentSelect.innerHTML = '<option value="">Сначала выберите дом</option>';
                selectedApartmentInfo.style.display = 'none';
                soldNotice.style.display = 'none';
                apartmentFullDetails.style.display = 'none';
                resetCalculation();

                if (complex) {
                    const sections = [...new Set(apartmentsData
                        .filter(item => item["Название ЖК"] === complex)
                        .map(item => item["Название дома"])
                        .filter(Boolean)
                    )];
                    sectionSelect.innerHTML = '<option value="">Выберите дом</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        sectionSelect.appendChild(option);
                    });
                }
            });

            // При изменении дома
            sectionSelect.addEventListener('change', function() {
                const complex = complexSelect.value;
                const section = this.value;
                apartmentSelect.disabled = !section;
                selectedApartmentInfo.style.display = 'none';
                soldNotice.style.display = 'none';
                apartmentFullDetails.style.display = 'none';
                resetCalculation();

                if (complex && section) {
                    const apartments = apartmentsData
                        .filter(item => 
                            item["Название ЖК"] === complex && 
                            item["Название дома"] === section
                        )
                        .map(item => ({
                            number: item["Номер помещения"],
                            basePrice: item["Цена"],
                            discountPrice: item["Цена продажи"],
                            complex: item["Название ЖК"],
                            section: item["Название дома"],
                            type: item["Тип помещения"],
                            status: item["Статус"],
                            roomType: item["Классическая комнатность"],
                            area: item["Площадь, м2"],
                            planUrl: item["3D тур квартиры"]
                        }));

                    apartmentSelect.innerHTML = '<option value="">Выберите квартиру</option>';
                    apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment.number;
                        option.textContent = `Квартира ${apartment.number}`;
                        option.dataset.basePrice = apartment.basePrice;
                        option.dataset.discountPrice = apartment.discountPrice;
                        option.dataset.complex = apartment.complex;
                        option.dataset.section = apartment.section;
                        option.dataset.status = apartment.status;
                        option.dataset.roomType = apartment.roomType;
                        option.dataset.area = apartment.area;
                        option.dataset.planUrl = apartment.planUrl || '';
                        apartmentSelect.appendChild(option);
                    });
                }
            });

            // При изменении квартиры
            apartmentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                selectedApartmentInfo.style.display = 'none';
                soldNotice.style.display = 'none';
                apartmentFullDetails.style.display = 'none';
                resetCalculation();

                if (selectedOption.value) {
                    currentBasePrice = parseInt(selectedOption.dataset.basePrice) || 0;
                    currentDiscountPrice = parseInt(selectedOption.dataset.discountPrice) || 0;
                    currentStatus = selectedOption.dataset.status || '';
                    currentComplex = selectedOption.dataset.complex;
                    currentSection = selectedOption.dataset.section;
                    currentApartmentNumber = selectedOption.value;
                    currentRoomType = selectedOption.dataset.roomType;
                    currentArea = selectedOption.dataset.area;
                    currentPlanUrl = selectedOption.dataset.planUrl;

                    if (currentStatus === "Продано") {
                        soldNotice.style.display = 'block';
                        return;
                    }

                    apartmentDetails.innerHTML = `
                        <div>ЖК: ${currentComplex}</div>
                        <div>Дом: ${currentSection}</div>
                        <div>Квартира: ${currentApartmentNumber}</div>
                    `;
                    selectedApartmentInfo.style.display = 'block';

                    updateApartmentFullDetails();
                    updatePriceDisplay();
                    
                    calculate();
                }
            });

            // Функция обновления полной информации о квартире
            function updateApartmentFullDetails() {
                apartmentComplex.textContent = `Жилой комплекс: ${currentComplex}`;
                apartmentSection.textContent = `Дом: ${currentSection}`;
                apartmentNumber.textContent = `Квартира: ${currentApartmentNumber}`;
                apartmentRooms.textContent = `Комнатность: ${getRoomTypeText(parseInt(currentRoomType))}`;
                apartmentArea.textContent = `Площадь: ${currentArea} м²`;
                
                if (currentPlanUrl && currentPlanUrl.trim() !== '') {
                    apartmentPlan.innerHTML = `<a href="${currentPlanUrl}" target="_blank" class="plan-button">План квартиры</a>`;
                } else {
                    apartmentPlan.innerHTML = '';
                }
                
                apartmentFullDetails.style.display = 'block';
            }

            // Функция обновления отображения цен
            function updatePriceDisplay() {
                basePriceDisplay.textContent = formatMoney(currentBasePrice);
            }

            // Функция округления до 4 знаков
            function roundUpTo4Digits(amount) {
                return Math.ceil(amount / 10000) * 10000;
            }
            
            // Функция расчета скидки на квартиру без учета ремонта
            function calculateDiscountWithoutRepair(contractPrice, repairCost) {
                const priceWithoutRepair = contractPrice - repairCost;
                
                if (priceWithoutRepair < currentBasePrice) {
                    return Math.ceil(currentBasePrice - priceWithoutRepair);
                }
                return 0;
            }
            
            // Функция сброса расчетов
            function resetCalculation() {
                currentBasePrice = 0;
                currentDiscountPrice = 0;
                currentStatus = '';
                updatePriceDisplay();
                
                familyClientPV.textContent = formatMoney(0);
                familyKV.textContent = formatMoney(0);
                familyContractPrice.textContent = formatMoney(0);
                familyLoanBody.textContent = formatMoney(0);
                familyDiscount.textContent = "Нет скидки";
                familyDiscount.className = "no-discount";
                familyWarning.style.display = 'none';
                
                standardClientPV.textContent = formatMoney(0);
                standardKV.textContent = formatMoney(0);
                standardContractPrice.textContent = formatMoney(0);
                standardLoanBody.textContent = formatMoney(0);
                standardDiscount.textContent = "Нет скидки";
                standardDiscount.className = "no-discount";
            }
            
            // Функция расчета для семейной ипотеки
            function calculateFamilyMortgage() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(repairCostInput.value) || 0;
                const dduObjects = parseInt(dduObjectsInput.value) || 0;
                const kvSubsidyPercent = parseFloat(kvSubsidyInput.value) || 0;
                const clientPVPercent = parseFloat(clientPVPercentInput.value) || 0;
                
                let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
                let iterations = 0;
                const maxIterations = 20;
                
                while (iterations < maxIterations) {
                    let clientPVRub = contractPrice * (clientPVPercent / 100);
                    
                    if (contractPrice - clientPVRub >= 6000000) {
                        familyWarning.style.display = 'block';
                        familyClientPV.textContent = "Увеличить ПВ клиента";
                        familyKV.textContent = formatMoney(0);
                        familyContractPrice.textContent = formatMoney(0);
                        familyLoanBody.textContent = formatMoney(0);
                        familyDiscount.textContent = "Нет скидки";
                        familyDiscount.className = "no-discount";
                        return;
                    }
                    
                    let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                    newContractPrice = roundUpTo4Digits(newContractPrice);
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    
                    contractPrice = newContractPrice;
                    iterations++;
                }
                
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                let loanBody = contractPrice - clientPVRub;
                
                if (contractPrice - clientPVRub >= 6000000) {
                    familyWarning.style.display = 'block';
                    familyClientPV.textContent = "Увеличить ПВ клиента";
                    familyKV.textContent = formatMoney(0);
                    familyContractPrice.textContent = formatMoney(0);
                    familyLoanBody.textContent = formatMoney(0);
                    familyDiscount.textContent = "Нет скидки";
                    familyDiscount.className = "no-discount";
                    return;
                }
                
                const discountWithoutRepair = calculateDiscountWithoutRepair(contractPrice, repairCost);
                
                familyClientPV.textContent = formatMoney(clientPVRub);
                familyKV.textContent = formatMoney(kvRub);
                familyContractPrice.textContent = formatMoney(contractPrice);
                familyLoanBody.textContent = formatMoney(loanBody);
                
                if (discountWithoutRepair > 0) {
                    familyDiscount.textContent = formatMoney(discountWithoutRepair);
                    familyDiscount.className = "discount";
                } else {
                    familyDiscount.textContent = "Нет скидки";
                    familyDiscount.className = "no-discount";
                }
                
                familyWarning.style.display = 'none';
            }
            
            // Функция расчета для стандартной ипотеки
            function calculateStandardMortgage() {
                const adjustedDiscountPrice = getAdjustedDiscountPrice();
                const repairCost = parseInt(repairCostInput.value) || 0;
                const dduObjects = parseInt(dduObjectsInput.value) || 0;
                const kvSubsidyPercent = parseFloat(kvSubsidyInput.value) || 0;
                const clientPVPercent = parseFloat(clientPVPercentInput.value) || 0;
                
                let contractPrice = adjustedDiscountPrice + repairCost + dduObjects;
                let iterations = 0;
                const maxIterations = 20;
                
                while (iterations < maxIterations) {
                    let clientPVRub = contractPrice * (clientPVPercent / 100);
                    let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                    let newContractPrice = adjustedDiscountPrice + repairCost + dduObjects + kvRub;
                    newContractPrice = roundUpTo4Digits(newContractPrice);
                    
                    if (Math.abs(newContractPrice - contractPrice) < 1) {
                        break;
                    }
                    
                    contractPrice = newContractPrice;
                    iterations++;
                }
                
                let clientPVRub = contractPrice * (clientPVPercent / 100);
                let kvRub = (contractPrice - clientPVRub) * (kvSubsidyPercent / 100);
                let loanBody = contractPrice - clientPVRub;
                
                const discountWithoutRepair = calculateDiscountWithoutRepair(contractPrice, repairCost);
                
                standardClientPV.textContent = formatMoney(clientPVRub);
                standardKV.textContent = formatMoney(kvRub);
                standardContractPrice.textContent = formatMoney(contractPrice);
                standardLoanBody.textContent = formatMoney(loanBody);
                
                if (discountWithoutRepair > 0) {
                    standardDiscount.textContent = formatMoney(discountWithoutRepair);
                    standardDiscount.className = "discount";
                } else {
                    standardDiscount.textContent = "Нет скидки";
                    standardDiscount.className = "no-discount";
                }
            }
            
            // Функция расчета
            function calculate() {
                if (currentStatus === "Продано") {
                    return;
                }
                
                calculateFamilyMortgage();
                calculateStandardMortgage();
            }
            
            // Слушатели событий
            managerDiscountCheckbox.addEventListener('change', calculate);
            repairCostInput.addEventListener('input', calculate);
            dduObjectsInput.addEventListener('input', calculate);
            kvSubsidyInput.addEventListener('input', calculate);
            clientPVPercentInput.addEventListener('input', calculate);
            
            // Инициализация
            populateComplexes();
            kvInitialized = true;
        }

        // Загрузка данных из Google Таблицы
        async function loadApartmentsData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                // Фильтруем только квартиры и исключаем статус "Субаренда (продано)"
                apartmentsData = data.filter(item => {
                    const isApartment = item["Тип помещения"] && item["Тип помещения"].toLowerCase() === "квартира";
                    const isNotSubRent = item["Статус"] !== "Субаренда (продано)";
                    
                    return isApartment && isNotSubRent;
                });
                
                // Инициализируем активный калькулятор
                const activeButton = document.querySelector('.calc-button.active');
                if (activeButton) {
                    const calculatorId = activeButton.getAttribute('data-calc');
                    if (calculatorId === 'chpv-300-3') {
                        initCHPV3003Calculator();
                    } else if (calculatorId === 'kv') {
                        initKVCalculator();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                const complexSelects = document.querySelectorAll('[id$="complexSelect"]');
                complexSelects.forEach(select => {
                    select.innerHTML = '<option value="">Ошибка загрузки данных</option>';
                });
            }
        }

        // Загружаем данные при загрузке страницы
        loadApartmentsData();
    </script>
</body>
</html>

